<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Artifact Zero</title>
<link rel="icon" href="/static/favicon.svg">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#08090d;--s1:#0e1017;--s2:#161a23;--border:#1e232e;
  --text:#e0e2e9;--dim:#5a6275;--muted:#3d4452;
  --green:#22c55e;--blue:#4a90d9;--purple:#a78bfa;--amber:#f59e0b;--red:#ef4444;
  --mono:'JetBrains Mono',monospace;--sans:'DM Sans',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);-webkit-font-smoothing:antialiased;overflow:hidden}

/* ── SHELL FRAME ── */
.shell{display:flex;flex-direction:column;height:100vh}

/* Top bar — NEVER changes */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:44px;min-height:44px;
  background:var(--s1);border-bottom:1px solid var(--border);
  z-index:100;
}
.logo{
  font-family:var(--mono);font-weight:700;font-size:12px;
  letter-spacing:2px;color:var(--green);cursor:pointer;
  display:flex;align-items:center;gap:8px;
}
.logo img{width:20px;height:20px}
.logo:hover{opacity:.85}

/* Nav */
.nav{display:flex;gap:2px;align-items:center}
.nav-btn{
  font-family:var(--mono);font-size:10px;letter-spacing:1px;
  padding:6px 12px;border-radius:4px;cursor:pointer;
  color:var(--dim);background:transparent;border:none;
  transition:all .15s;font-weight:600;
}
.nav-btn:hover{color:var(--text);background:var(--s2)}
.nav-btn.active{color:var(--text);background:var(--s2)}
.nav-btn.active[data-section="relay"]{color:var(--green)}
.nav-btn.active[data-section="control"]{color:var(--blue)}
.nav-btn.active[data-section="lab"]{color:var(--purple)}
.nav-btn.active[data-section="live"]{color:var(--amber)}

/* User area */
.user-area{display:flex;align-items:center;gap:10px}
.user-name{font-family:var(--mono);font-size:10px;color:var(--dim)}
.user-turns{font-family:var(--mono);font-size:10px;color:var(--green)}
.btn-logout{
  font-family:var(--mono);font-size:9px;color:var(--dim);
  background:none;border:1px solid var(--border);padding:3px 8px;
  border-radius:4px;cursor:pointer;
}
.btn-logout:hover{color:var(--text);border-color:var(--dim)}
.btn-auth{
  font-family:var(--mono);font-size:10px;color:var(--green);
  background:none;border:1px solid var(--green);padding:4px 12px;
  border-radius:4px;cursor:pointer;font-weight:600;
}
.btn-auth:hover{background:var(--green);color:#000}

/* Accent strip under topbar — changes color per section */
.accent-strip{height:2px;transition:background .3s}
.accent-strip.relay{background:var(--green)}
.accent-strip.control{background:var(--blue)}
.accent-strip.lab{background:var(--purple)}
.accent-strip.live{background:var(--amber)}

/* Content area — the only thing that changes */
.content{flex:1;position:relative;overflow:hidden}
.content iframe{
  width:100%;height:100%;border:none;
  background:var(--bg);
}

/* Frozen bottom bar */
.bottombar{
  display:flex;align-items:center;gap:8px;
  padding:6px 16px;height:40px;min-height:40px;
  background:var(--s1);border-top:1px solid var(--border);
  z-index:100;
}
.search-wrap{
  flex:1;position:relative;
}
.search-input{
  width:100%;background:var(--s2);border:1px solid var(--border);
  color:var(--text);padding:6px 12px 6px 28px;border-radius:5px;
  font-family:var(--mono);font-size:11px;outline:none;
}
.search-input:focus{border-color:var(--green)}
.search-input::placeholder{color:var(--muted)}
.search-icon{
  position:absolute;left:8px;top:50%;transform:translateY(-50%);
  font-size:12px;color:var(--muted);pointer-events:none;
}
.search-results{
  display:none;position:absolute;bottom:calc(100% + 4px);left:0;right:0;
  background:var(--s1);border:1px solid var(--border);border-radius:6px;
  max-height:300px;overflow-y:auto;z-index:200;
}
.search-results.show{display:block}
.sr-item{
  padding:8px 12px;border-bottom:1px solid var(--border);cursor:pointer;
  font-size:12px;display:flex;justify-content:space-between;align-items:center;
}
.sr-item:hover{background:var(--s2)}
.sr-item:last-child{border-bottom:none}
.sr-type{
  font-family:var(--mono);font-size:9px;padding:2px 6px;border-radius:3px;
  text-transform:uppercase;letter-spacing:.5px;
}
.sr-type.protocol{background:rgba(34,197,94,.12);color:var(--green)}
.sr-type.session{background:rgba(74,144,217,.12);color:var(--blue)}
.sr-type.audit{background:rgba(167,139,250,.12);color:var(--purple)}
.sr-type.event{background:rgba(245,158,11,.12);color:var(--amber)}
.sr-empty{padding:12px;text-align:center;color:var(--dim);font-size:12px}
.bottom-status{
  font-family:var(--mono);font-size:9px;color:var(--muted);
  white-space:nowrap;
}

/* Auth overlay */
.auth-overlay{
  display:none;position:fixed;inset:0;z-index:200;
  background:rgba(8,9,13,.95);
  align-items:center;justify-content:center;
}
.auth-overlay.show{display:flex}
.auth-box{
  background:var(--s1);border:1px solid var(--border);
  border-radius:12px;padding:32px;width:90%;max-width:380px;
}
.auth-box h2{font-size:18px;font-weight:600;margin-bottom:4px;text-align:center}
.auth-box .sub{font-size:13px;color:var(--dim);text-align:center;margin-bottom:20px}
.auth-box label{
  display:block;font-family:var(--mono);font-size:10px;
  letter-spacing:1px;color:var(--dim);margin-bottom:4px;margin-top:12px;
  text-transform:uppercase;
}
.auth-box input{
  width:100%;background:var(--s2);border:1px solid var(--border);
  color:var(--text);padding:10px 12px;border-radius:6px;
  font-size:14px;font-family:var(--sans);outline:none;
}
.auth-box input:focus{border-color:var(--green)}
.auth-box .btn-submit{
  width:100%;padding:11px;margin-top:16px;border:none;border-radius:6px;
  background:var(--green);color:#000;font-weight:700;font-size:14px;
  cursor:pointer;font-family:var(--sans);
}
.auth-box .btn-submit:hover{background:#16a34a}
.auth-box .toggle{font-size:12px;color:var(--dim);text-align:center;margin-top:12px}
.auth-box .toggle a{color:var(--green);cursor:pointer}
.auth-box .err{color:var(--red);font-size:12px;margin-top:6px}

/* Mobile */
@media(max-width:640px){
  .topbar{padding:0 10px}
  .nav-btn{padding:5px 8px;font-size:9px}
  .user-name{display:none}
  .logo span{display:none}
}
</style>
</head>
<body>

<div class="shell">
  <!-- ── TOPBAR (never changes) ── -->
  <div class="topbar">
    <div class="logo" onclick="goHome()">
      <img src="/static/favicon.png" alt="0">
      <span>ARTIFACT ZERO</span>
    </div>
    <div class="nav" id="nav">
      <button class="nav-btn active" data-section="relay" onclick="go('relay')">RELAY</button>
      <button class="nav-btn" data-section="control" onclick="go('control')">CONTROL ROOM</button>
      <button class="nav-btn" data-section="lab" onclick="go('lab')">LAB</button>
      <button class="nav-btn" data-section="live" onclick="go('live')">LIVE</button>
    </div>
    <div class="user-area" id="userArea">
      <button class="btn-auth" onclick="showAuth('login')">Log in</button>
    </div>
  </div>

  <!-- Accent strip -->
  <div class="accent-strip relay" id="accentStrip"></div>

  <!-- ── CONTENT (this changes) ── -->
  <div class="content" id="content">
    <iframe id="frame" src="/relay"></iframe>
  </div>

  <!-- ── FROZEN BOTTOM BAR ── -->
  <div class="bottombar">
    <div class="search-wrap">
      <span class="search-icon">⌕</span>
      <input class="search-input" id="searchInput" type="text" placeholder="Search protocols, sessions, audits..." autocomplete="off">
      <div class="search-results" id="searchResults"></div>
    </div>
    <div class="bottom-status" id="bottomStatus">ready</div>
  </div>
</div>

<!-- ── AUTH OVERLAY ── -->
<div class="auth-overlay" id="authOverlay">
  <div class="auth-box">
    <h2 id="authTitle">Log In</h2>
    <div class="sub">One account. Every tool.</div>
    <div id="authForm"></div>
  </div>
</div>

<script>
const SECTIONS = {
  relay:   {url:'/relay',  color:'relay',   label:'RELAY'},
  control: {url:'/chat',   color:'control', label:'CONTROL ROOM'},
  lab:     {url:'/lab',    color:'lab',     label:'LAB'},
  live:    {url:'/live',   color:'live',    label:'LIVE'}
};

let currentSection = 'relay';
let user = null;

// ── NAV ──
function go(section) {
  if (section === currentSection) return;
  currentSection = section;
  const cfg = SECTIONS[section];

  // Update nav buttons
  document.querySelectorAll('.nav-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.section === section);
  });

  // Update accent strip
  const strip = document.getElementById('accentStrip');
  strip.className = 'accent-strip ' + cfg.color;

  // Load content
  const frame = document.getElementById('frame');
  frame.src = cfg.url;

  // Update URL without reload
  history.pushState({section}, '', '/app/' + section);
}

function goHome() {
  window.location.href = '/';
}

// ── AUTH ──
async function checkAuth() {
  try {
    const r = await fetch('/relay/me');
    if (r.ok) {
      user = await r.json();
      renderUser();
    }
  } catch(e) {}
}

function renderUser() {
  const area = document.getElementById('userArea');
  if (user) {
    area.innerHTML = `
      <span class="user-name">${user.username || user.email}</span>
      <span class="user-turns">${Math.max(0, user.turns_limit - user.turns_used)} turns</span>
      <button class="btn-logout" onclick="doLogout()">Logout</button>
    `;
  } else {
    area.innerHTML = `<button class="btn-auth" onclick="showAuth('login')">Log in</button>`;
  }
}

function showAuth(mode) {
  const overlay = document.getElementById('authOverlay');
  overlay.classList.add('show');
  const title = document.getElementById('authTitle');
  const form = document.getElementById('authForm');

  if (mode === 'login') {
    title.textContent = 'Log In';
    form.innerHTML = `
      <label>Email</label>
      <input type="email" id="a-email" placeholder="you@example.com">
      <label>Password</label>
      <input type="password" id="a-pass" placeholder="8+ characters">
      <div class="err" id="authErr"></div>
      <button class="btn-submit" onclick="doLogin()">Log In</button>
      <div class="toggle">No account? <a onclick="showAuth('signup')">Sign up</a></div>
      <div class="toggle"><a onclick="closeAuth()">Cancel</a></div>
    `;
  } else {
    title.textContent = 'Create Account';
    form.innerHTML = `
      <label>Username</label>
      <input type="text" id="a-user" placeholder="How others see you">
      <label>Email</label>
      <input type="email" id="a-email" placeholder="you@example.com">
      <label>Password</label>
      <input type="password" id="a-pass" placeholder="8+ characters">
      <div class="err" id="authErr"></div>
      <button class="btn-submit" onclick="doSignup()">Create Account</button>
      <div class="toggle">Have an account? <a onclick="showAuth('login')">Log in</a></div>
      <div class="toggle"><a onclick="closeAuth()">Cancel</a></div>
    `;
  }
}

function closeAuth() {
  document.getElementById('authOverlay').classList.remove('show');
}

async function doLogin() {
  const email = document.getElementById('a-email').value;
  const pass = document.getElementById('a-pass').value;
  const r = await fetch('/relay/login', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pass})});
  const d = await r.json();
  if (d.ok) {
    user = d;
    renderUser();
    closeAuth();
    // Reload current frame so it picks up auth
    document.getElementById('frame').src = SECTIONS[currentSection].url;
  } else {
    document.getElementById('authErr').textContent = d.error;
  }
}

async function doSignup() {
  const username = document.getElementById('a-user').value.trim();
  const email = document.getElementById('a-email').value;
  const pass = document.getElementById('a-pass').value;
  if (!username) { document.getElementById('authErr').textContent = 'Username required'; return; }
  const r = await fetch('/relay/signup', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password:pass, username})});
  const d = await r.json();
  if (d.ok) {
    user = {email, username, turns_used:0, turns_limit:50, plan:'free'};
    renderUser();
    closeAuth();
    document.getElementById('frame').src = SECTIONS[currentSection].url;
  } else {
    document.getElementById('authErr').textContent = d.error;
  }
}

async function doLogout() {
  await fetch('/relay/logout', {method:'POST'});
  user = null;
  renderUser();
  document.getElementById('frame').src = SECTIONS[currentSection].url;
}

// ── ROUTING ──
function initFromURL() {
  const path = window.location.pathname;
  if (path.startsWith('/app/')) {
    const section = path.replace('/app/', '');
    if (SECTIONS[section]) {
      currentSection = section;
      const cfg = SECTIONS[section];
      document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.section === section);
      });
      document.getElementById('accentStrip').className = 'accent-strip ' + cfg.color;
      document.getElementById('frame').src = cfg.url;
    }
  }
}

window.addEventListener('popstate', (e) => {
  if (e.state && e.state.section) go(e.state.section);
});

// ── INIT ──
checkAuth();
initFromURL();

// ── SEARCH ──
let searchTimeout = null;
const searchInput = document.getElementById('searchInput');
const searchResults = document.getElementById('searchResults');

searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) { searchResults.classList.remove('show'); return; }
  searchTimeout = setTimeout(() => doSearch(q), 300);
});

searchInput.addEventListener('focus', () => {
  if (searchInput.value.trim().length >= 2) searchResults.classList.add('show');
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-wrap')) searchResults.classList.remove('show');
});

async function doSearch(q) {
  document.getElementById('bottomStatus').textContent = 'searching...';
  try {
    const r = await fetch('/api/search', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({q})});
    const d = await r.json();
    if (d.results && d.results.length > 0) {
      searchResults.innerHTML = d.results.map(r => `
        <div class="sr-item" onclick="openResult('${r.type}','${r.id}')">
          <div>
            <div style="font-weight:500">${esc(r.title)}</div>
            <div style="font-size:10px;color:#5a6275;margin-top:2px">${r.date ? r.date.slice(0,16) : ''}</div>
          </div>
          <span class="sr-type ${r.type}">${r.type}</span>
        </div>
      `).join('');
    } else {
      searchResults.innerHTML = '<div class="sr-empty">No results for "' + esc(q) + '"</div>';
    }
    searchResults.classList.add('show');
    document.getElementById('bottomStatus').textContent = d.count + ' results';
  } catch(e) {
    document.getElementById('bottomStatus').textContent = 'search error';
  }
}

function openResult(type, id) {
  searchResults.classList.remove('show');
  searchInput.value = '';
  if (type === 'protocol' || type === 'session') go('relay');
  else if (type === 'audit') go('lab');
  else go('relay');
}

function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }

// ── ANALYTICS (SL Activity pattern) ──
const AZ_SESSION = 'az_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
let clickCount = 0;
let lastNav = Date.now();

function trackEvent(name, data) {
  try {
    fetch('/events', {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({event: name, data: {...data, session: AZ_SESSION, section: currentSection, ts: Date.now()}})
    });
  } catch(e) {}
}

// Track nav changes
const _origGo = go;
go = function(section) {
  trackEvent('nav_change', {from: currentSection, to: section});
  lastNav = Date.now();
  _origGo(section);
};

// Track clicks
document.addEventListener('click', (e) => {
  clickCount++;
  const el = e.target;
  if (el.tagName === 'BUTTON' || el.tagName === 'A' || el.closest('button') || el.closest('a')) {
    trackEvent('click', {
      tag: el.tagName,
      id: el.id || '',
      text: (el.textContent || '').slice(0,40),
      class: (el.className || '').slice(0,60)
    });
  }
});

// Track search
searchInput.addEventListener('blur', () => {
  if (searchInput.value.trim()) {
    trackEvent('search', {query: searchInput.value.trim()});
  }
});

// Track session heartbeat
setInterval(() => {
  trackEvent('heartbeat', {clicks: clickCount, section: currentSection, elapsed: Date.now() - lastNav});
}, 60000);

// Track page load
trackEvent('shell_load', {url: window.location.href, referrer: document.referrer});
</script>
</body>
</html>
