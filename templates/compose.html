<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compose — Artifact Zero</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0c10;--surface:#12151b;--surface2:#1a1e27;--border:#252a35;
  --text:#e8eaf0;--muted:#6b7280;--accent:#00e89c;
  --red:#ef4444;--amber:#f59e0b;--purple:#a78bfa;--blue:#3b82f6;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased;min-height:100vh;display:flex;flex-direction:column}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;opacity:.03;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
}

/* TOOLBAR */
.toolbar{
  position:fixed;top:0;left:0;right:0;z-index:100;
  padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
  background:rgba(10,12,16,.95);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
}
.toolbar-left{display:flex;align-items:center;gap:12px}
.toolbar-logo{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;color:var(--accent);letter-spacing:2px;text-decoration:none}
.toolbar-sep{width:1px;height:20px;background:var(--border)}
.toolbar-title{font-size:13px;color:var(--muted)}
.toolbar-right{display:flex;align-items:center;gap:10px}
.toolbar-btn{
  padding:6px 14px;border-radius:6px;border:none;font-size:12px;font-weight:600;
  cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s;
}
.btn-discard{background:transparent;color:var(--muted);border:1px solid var(--border)}
.btn-discard:hover{color:var(--red);border-color:var(--red)}
.btn-send{background:var(--blue);color:#fff}
.btn-send:hover{background:#2563eb}

/* EMAIL COMPOSE AREA */
.compose{
  max-width:720px;width:100%;margin:0 auto;padding:60px 20px 40px;flex:1;
  display:flex;flex-direction:column;
}

.email-header{padding:16px 0;border-bottom:1px solid var(--border)}
.email-row{display:flex;align-items:center;padding:8px 0;gap:8px}
.email-label{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;width:60px;flex-shrink:0}
.email-input{
  flex:1;background:transparent;border:none;color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:14px;outline:none;padding:4px 0;
}
.email-input::placeholder{color:#3d4452}
.subject-input{font-size:16px;font-weight:600}

/* Body */
.email-body{flex:1;padding:20px 0;position:relative}
.email-body textarea{
  width:100%;min-height:300px;background:transparent;border:none;color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.8;
  resize:none;outline:none;
}
.email-body textarea::placeholder{color:#3d4452}

/* STRUCTURE PANEL - the spellcheck replacement */
.structure-panel{
  position:fixed;bottom:0;left:0;right:0;z-index:90;
  background:var(--surface);border-top:1px solid var(--border);
  transform:translateY(100%);transition:transform .3s ease;
  max-height:45vh;overflow:hidden;display:flex;flex-direction:column;
}
.structure-panel.open{transform:translateY(0)}

.sp-header{
  padding:12px 16px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);flex-shrink:0;cursor:pointer;
}
.sp-header:hover{background:var(--surface2)}
.sp-score{display:flex;align-items:center;gap:10px}
.sp-nii{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700}
.sp-nii.high{color:var(--accent)}.sp-nii.mid{color:var(--amber)}.sp-nii.low{color:var(--red)}
.sp-label{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)}
.sp-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:3px 8px;border-radius:4px;font-weight:600}
.sp-badge.pass{background:#00e89c22;color:var(--accent)}
.sp-badge.warn{background:#f59e0b22;color:var(--amber)}
.sp-badge.fail{background:#ef444422;color:var(--red)}
.sp-toggle{font-family:'JetBrains Mono',monospace;font-size:18px;color:var(--muted);transition:transform .2s}
.structure-panel.open .sp-toggle{transform:rotate(180deg)}

.sp-body{padding:16px;overflow-y:auto;flex:1}

.sp-section{margin-bottom:16px}
.sp-section-title{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}

.sp-item{display:flex;align-items:flex-start;gap:8px;padding:6px 0;font-size:13px;line-height:1.4}
.sp-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:6px}
.sp-dot.green{background:var(--accent)}.sp-dot.red{background:var(--red)}.sp-dot.amber{background:var(--amber)}

.sp-tags{display:flex;flex-wrap:wrap;gap:4px}
.sp-tag{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 7px;border-radius:3px;background:var(--surface2)}
.sp-tag.green{color:var(--accent)}.sp-tag.red{color:var(--red)}.sp-tag.amber{color:var(--amber)}

/* SCORE BAR - persistent bottom bar when panel is closed */
.score-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:80;
  padding:10px 16px;display:flex;align-items:center;justify-content:space-between;
  background:var(--surface);border-top:1px solid var(--border);
  cursor:pointer;transition:opacity .2s;
}
.structure-panel.open ~ .score-bar{opacity:0;pointer-events:none}
.sb-left{display:flex;align-items:center;gap:10px}
.sb-nii{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.sb-nii.high{color:var(--accent)}.sb-nii.mid{color:var(--amber)}.sb-nii.low{color:var(--red)}.sb-nii.none{color:var(--muted)}
.sb-text{font-size:12px;color:var(--muted)}
.sb-right{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)}

/* Underlines in textarea simulation */
.highlight-hedge{background:rgba(245,158,11,.15);border-bottom:2px solid var(--amber);padding:0 1px}
.highlight-false{background:rgba(239,68,68,.15);border-bottom:2px solid var(--red);padding:0 1px}
.highlight-missing{border-bottom:2px dashed var(--amber)}

@media(max-width:600px){
  .compose{padding:56px 12px 80px}
  .email-label{width:40px;font-size:10px}
  .structure-panel{max-height:55vh}
}
</style>
</head>
<body>

<div class="toolbar">
  <div class="toolbar-left">
    <a href="/" class="toolbar-logo">AZ</a>
    <div class="toolbar-sep"></div>
    <span class="toolbar-title">New message</span>
  </div>
  <div class="toolbar-right">
    <button class="toolbar-btn btn-discard" onclick="discard()">Discard</button>
    <button class="toolbar-btn btn-send" onclick="sendEmail()">Send</button>
  </div>
</div>

<div class="compose">
  <div class="email-header">
    <div class="email-row">
      <span class="email-label">To</span>
      <input class="email-input" id="eTo" type="email" placeholder="recipient@example.com">
    </div>
    <div class="email-row">
      <span class="email-label">Subject</span>
      <input class="email-input subject-input" id="eSubject" placeholder="Subject">
    </div>
  </div>
  <div class="email-body">
    <textarea id="eBody" placeholder="Write your message..."></textarea>
  </div>
</div>

<!-- PERSISTENT SCORE BAR -->
<div class="score-bar" id="scoreBar" onclick="openPanel()">
  <div class="sb-left">
    <span class="sb-nii none" id="sbNii">—</span>
    <span class="sb-text" id="sbText">Start typing to see structural score</span>
  </div>
  <div class="sb-right" id="sbMeta"></div>
</div>

<!-- STRUCTURE PANEL (slides up) -->
<div class="structure-panel" id="panel">
  <div class="sp-header" onclick="togglePanel()">
    <div class="sp-score">
      <span class="sp-nii" id="spNii">—</span>
      <div>
        <div class="sp-label" id="spLabel">STRUCTURAL SCORE</div>
      </div>
      <span class="sp-badge" id="spBadge" style="display:none"></span>
    </div>
    <span class="sp-toggle">▼</span>
  </div>
  <div class="sp-body" id="spBody">
    <div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Write your email. Structure check runs automatically.</div>
  </div>
</div>

<script src="/static/nti-score-component.js"></script>
<script>
let scoreTimer = null;
let lastText = '';
let panelOpen = false;
let lastScore = null;

const body = document.getElementById('eBody');

// Auto-score as you type (debounced)
body.addEventListener('input', () => {
  clearTimeout(scoreTimer);
  const text = body.value.trim();
  if (text.length < 20) {
    updateBar(null);
    return;
  }
  scoreTimer = setTimeout(() => {
    if (text !== lastText) {
      lastText = text;
      runScore(text);
    }
  }, 800);
});

async function runScore(text) {
  try {
    const r = await fetch('/nti', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    const d = await r.json();
    if (!d.error) {
      lastScore = d;
      updateBar(d);
      updatePanel(d);
    }
  } catch (e) { /* silent */ }
}

function cls(n) { return n >= .8 ? 'high' : n >= .5 ? 'mid' : 'low'; }
function lbl(n) { return n >= .8 ? 'HIGH INTEGRITY' : n >= .5 ? 'MODERATE' : n >= .2 ? 'LOW' : 'CRITICAL'; }

function updateBar(d) {
  const niiEl = document.getElementById('sbNii');
  const txtEl = document.getElementById('sbText');
  const metaEl = document.getElementById('sbMeta');
  
  if (!d) {
    niiEl.textContent = '—';
    niiEl.className = 'sb-nii none';
    txtEl.textContent = 'Start typing to see structural score';
    metaEl.textContent = '';
    return;
  }
  
  const s = d.nii?.nii_score ?? 0;
  const fm = d.parent_failure_modes || {};
  const tilt = d.tilt_taxonomy || [];
  const lat = d.telemetry?.latency_ms || '—';
  
  const active = ['UDDS','DCE','CCA'].filter(m => {
    const st = fm[m] ? fm[m][m.toLowerCase()+'_state'] || '' : '';
    return st.includes('CONFIRMED') || st.includes('PROBABLE');
  });
  
  niiEl.textContent = s.toFixed(2);
  niiEl.className = 'sb-nii ' + cls(s);
  
  if (active.length === 0 && tilt.length === 0) {
    txtEl.textContent = 'Structure looks clean';
  } else {
    const issues = [];
    if (active.length) issues.push(active.length + ' failure mode' + (active.length > 1 ? 's' : ''));
    if (tilt.length) issues.push(tilt.length + ' tilt pattern' + (tilt.length > 1 ? 's' : ''));
    txtEl.textContent = issues.join(' · ');
  }
  
  metaEl.textContent = lat + 'ms';
}

function updatePanel(d) {
  const text = lastText;
  const spBody = document.getElementById('spBody');
  spBody.innerHTML = '';
  spBody.appendChild(NTIScore.render(d, text));
}

function openPanel() {
  panelOpen = true;
  document.getElementById('panel').classList.add('open');
}

function togglePanel() {
  panelOpen = !panelOpen;
  document.getElementById('panel').classList.toggle('open', panelOpen);
}

function discard() {
  if (body.value.trim() && !confirm('Discard this message?')) return;
  document.getElementById('eTo').value = '';
  document.getElementById('eSubject').value = '';
  body.value = '';
  lastText = '';
  lastScore = null;
  updateBar(null);
  document.getElementById('spBody').innerHTML = '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">Write your email. Structure check runs automatically.</div>';
  document.getElementById('spBadge').style.display = 'none';
  document.getElementById('spNii').textContent = '—';
  document.getElementById('spNii').className = 'sp-nii';
  panelOpen = false;
  document.getElementById('panel').classList.remove('open');
}

function sendEmail() {
  const to = document.getElementById('eTo').value.trim();
  const subject = document.getElementById('eSubject').value.trim();
  const msg = body.value.trim();
  
  if (!msg) { alert('Write a message first.'); return; }
  
  const s = lastScore?.nii?.nii_score ?? null;
  
  if (s !== null && s < 0.5) {
    if (!confirm('Structural score is ' + s.toFixed(2) + '. Send anyway?')) {
      openPanel();
      return;
    }
  }
  
  alert('In production, this sends via your email client.\n\nStructural score: ' + (s !== null ? s.toFixed(2) : 'not scored') + '\n\nThis is a demo of structure check replacing spellcheck.');
}

// Keyboard shortcut: Cmd/Ctrl+Enter to score immediately
document.addEventListener('keydown', e => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
    e.preventDefault();
    const text = body.value.trim();
    if (text.length >= 20) {
      lastText = text;
      runScore(text);
      openPanel();
    }
  }
});
</script>
<script src="/static/az-nav.js"></script>
</body>
</html>
