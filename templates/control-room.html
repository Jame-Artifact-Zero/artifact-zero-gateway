<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NTI Control Room — Artifact Zero</title>
<link rel="icon" href="/static/favicon.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap');
:root{--bg:#08090c;--s1:#0f1117;--s2:#161a23;--s3:#1e232e;--border:#252b38;--text:#d4d8e3;--muted:#5a6275;--dim:#3a4050;--accent:#c96442;--accent2:#e07a55;--blue:#4a90d9;--green:#34d399;--red:#f87171;--amber:#fbbf24;--purple:#a78bfa}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased}
.app{display:flex;height:calc(100vh - 37px)}

/* Sidebar */
.sb{width:250px;background:var(--s1);display:flex;flex-direction:column;flex-shrink:0;border-right:1px solid var(--border)}
.sb-head{padding:14px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border)}
.z0{width:32px;height:32px;border-radius:8px;background:transparent;display:flex;align-items:center;justify-content:center;overflow:hidden}.z0 img{width:100%;height:100%;object-fit:contain}
.sb-t{font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;color:var(--text);letter-spacing:1px}
.sb-s{font-size:10px;color:var(--muted);margin-top:1px}

.models{padding:10px;border-bottom:1px solid var(--border)}
.mb{width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:8px;margin-bottom:4px;transition:all .15s;font-family:'DM Sans',sans-serif}
.mb:hover{background:var(--s2);color:var(--text)}
.mb.on{background:var(--s2);color:var(--text);border-color:var(--accent)}
.md{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.md.cl{background:#c96442}.md.gp{background:#19c37d}

.sb-ch{flex:1;overflow-y:auto;padding:6px 8px}
.sb-sc{padding:14px 8px 4px;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.si{padding:9px 10px;border-radius:6px;font-size:12px;color:var(--muted);cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:background .1s}
.si:hover{background:var(--s2)}.si.on{background:var(--s2);color:var(--text)}

.sb-ft{padding:10px;border-top:1px solid var(--border)}
.lb{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.ki{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:5px;padding:7px 9px;font-size:11px;color:var(--muted);outline:none;font-family:'IBM Plex Mono',monospace}
.ki:focus{border-color:var(--accent);color:var(--text)}.ki::placeholder{color:var(--dim)}
.ub{margin-top:10px}.ut{height:4px;background:var(--s3);border-radius:2px;overflow:hidden}
.uf{height:100%;background:var(--green);border-radius:2px;transition:width .3s}.uf.w{background:var(--amber)}.uf.x{background:var(--red)}
.ux{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dim);margin-top:4px;display:flex;justify-content:space-between}

/* Main */
.mn{flex:1;display:flex;flex-direction:column;min-width:0}
.hd{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--s1)}
.hl{display:flex;align-items:center;gap:8px}
.hb{font-family:'IBM Plex Mono',monospace;font-size:12px;display:flex;align-items:center;gap:6px;color:var(--text)}
.zs{width:22px;height:22px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:#fff;font-family:'IBM Plex Mono',monospace}
.ns{display:flex;align-items:center;gap:6px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--muted);cursor:pointer;user-select:none}
.ns .ld{width:7px;height:7px;border-radius:50%;background:var(--green);transition:all .2s}.ns .ld.off{background:var(--dim)}

.ms{flex:1;overflow-y:auto}
.mi{max-width:700px;margin:0 auto;padding:20px 20px 140px}

.wc{text-align:center;padding:24px 20px 40px}
.wc .zl{width:56px;height:56px;border-radius:14px;background:transparent;display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden}.wc .zl img{width:100%;height:100%;object-fit:contain}
.wc h2{font-size:20px;font-weight:600;margin-bottom:8px}
.wc p{font-size:14px;color:var(--muted);max-width:380px;margin:0 auto;line-height:1.5}
.wc .fr{margin-top:16px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--green);background:rgba(52,211,153,.08);display:inline-block;padding:6px 14px;border-radius:20px;border:1px solid rgba(52,211,153,.2)}

.m{padding:18px 0}.m+.m{border-top:1px solid rgba(255,255,255,.03)}
.mr{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.mr.y{color:var(--text)}
.mb2{font-size:15px;line-height:1.65;white-space:pre-wrap;word-break:break-word}

.ns2{margin-top:10px;padding:8px 12px;background:var(--s2);border:1px solid var(--border);border-radius:8px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;font-family:'IBM Plex Mono',monospace}
.ns2.hd2{display:none}
.nc{font-size:10px;display:flex;align-items:center;gap:3px}
.nc .l2{color:var(--dim)}.nc .v2{font-weight:600}
.nc .v2.g{color:var(--green)}.nc .v2.r{color:var(--red)}.nc .v2.w{color:var(--amber)}.nc .v2.b{color:var(--blue)}.nc .v2.m{color:var(--muted)}.nc .v2.p{color:var(--purple)}
.nf{width:100%;font-size:9px;color:var(--red);margin-top:2px}

.iw{position:fixed;bottom:0;right:0;left:250px;padding:12px 20px 16px;background:linear-gradient(transparent,var(--bg) 25%);z-index:10}
.ib{max-width:700px;margin:0 auto;position:relative}
.if2{width:100%;min-height:48px;max-height:180px;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:13px 50px 13px 18px;font-size:14px;line-height:1.5;color:var(--text);outline:none;resize:none;font-family:'DM Sans',sans-serif}
.if2:focus{border-color:var(--accent)}.if2::placeholder{color:var(--dim)}
.sb2{position:absolute;right:8px;bottom:8px;width:32px;height:32px;border-radius:50%;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.sb2:hover{background:var(--accent2)}.sb2:disabled{background:var(--s3);cursor:default}
.sb2 svg{width:14px;height:14px;fill:#fff}

.dt{display:inline-flex;gap:3px}.dt span{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:bt 1.4s infinite}.dt span:nth-child(2){animation-delay:.2s}.dt span:nth-child(3){animation-delay:.4s}
@keyframes bt{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}

/* Paywall */
.pw{display:none;position:fixed;inset:0;background:rgba(8,9,12,.92);z-index:100;align-items:center;justify-content:center}.pw.sh{display:flex}
.pc{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:40px;max-width:440px;width:90%;text-align:center}
.pc .zl{width:48px;height:48px;border-radius:12px;background:transparent;display:inline-flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden}.pc .zl img{width:100%;height:100%;object-fit:contain}
.pc h2{font-size:20px;font-weight:600;margin-bottom:8px}
.pc p{font-size:14px;color:var(--muted);line-height:1.5;margin-bottom:24px}
.pp{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
.pl{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s}
.pl:hover{border-color:var(--accent);background:var(--s2)}
.pl.sel{border-color:var(--accent);background:rgba(201,100,66,.08)}
.pn{font-weight:600;font-size:14px}.pd{font-size:11px;color:var(--muted);margin-top:2px}
.pr{font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:16px;color:var(--accent)}
.pb{width:100%;padding:14px;border-radius:10px;background:var(--accent);color:#fff;border:none;font-size:15px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:background .15s}.pb:hover{background:var(--accent2)}
.px{margin-top:12px;font-size:12px;color:var(--muted);cursor:pointer;display:inline-block}.px:hover{color:var(--text)}

@media(max-width:768px){.sb{display:none}.iw{left:0}.mi{padding:16px 14px 130px}}
</style>
</head>
<body>
<div style="position:fixed;top:0;left:0;right:0;z-index:200;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;background:rgba(10,12,16,.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid rgba(37,42,53,.5)">
  <a href="/" style="font-family:monospace;font-weight:700;font-size:14px;letter-spacing:2px;color:#22c55e;text-decoration:none">ARTIFACT ZERO</a>
  <nav style="display:flex;gap:16px">
    <a href="/dashboard" style="font-family:monospace;font-size:10px;color:#6b7280;text-decoration:none;letter-spacing:1.5px">DASHBOARD</a>
    <a href="/safecheck" style="font-family:monospace;font-size:10px;color:#6b7280;text-decoration:none;letter-spacing:1.5px">SAFECHECK</a>
    <a href="/wall" style="font-family:monospace;font-size:10px;color:#6b7280;text-decoration:none;letter-spacing:1.5px">WALL</a>
    <a href="/logout" style="font-family:monospace;font-size:10px;color:#6b7280;text-decoration:none;letter-spacing:1.5px">LOG OUT</a>
  </nav>
</div>
<!-- NAV BAR -->
<div data-shell-nav style="display:flex;align-items:center;justify-content:space-between;padding:8px 16px;border-bottom:1px solid #252b38;background:#0f1117;font-family:'IBM Plex Mono',monospace;font-size:11px">
  <a href="/" style="color:#34d399;font-weight:700;letter-spacing:2px;font-size:13px;text-decoration:none">ARTIFACT ZERO</a>
  <div style="display:flex;gap:16px;align-items:center">
    <a href="/relay" style="color:#5a6275;text-decoration:none">RELAY</a>
    <a href="/chat" style="color:#34d399;font-weight:600;text-decoration:none">CONTROL ROOM</a>
    <a href="/lab" style="color:#5a6275;text-decoration:none">LAB</a>
    <a href="/live" style="color:#5a6275;text-decoration:none">LIVE</a>
  </div>
</div>
<div class="app">
<div class="sb">
  <div class="sb-head"><div class="z0"><img src="/static/favicon.png" alt="0"></div><div><div class="sb-t">CONTROL ROOM</div><div class="sb-s">NTI-scored AI chat</div></div></div>
  <div class="models">
    <button class="mb on" onclick="pick('claude')" id="b-claude"><div class="md cl"></div>Claude</button>
    <button class="mb" onclick="pick('gpt')" id="b-gpt"><div class="md gp"></div>ChatGPT</button>
  </div>
  <div class="sb-ch"><div class="sb-sc">Today</div><div class="si on" id="cc">New conversation</div></div>
  <div class="sb-ft">
    <div class="lb">API Key <span style="font-size:8px;color:var(--green)">(optional)</span></div>
    <input type="password" class="ki" id="ak" placeholder="Your key or leave blank for free" autocomplete="off">
    <div class="ub"><div class="ut"><div class="uf" id="ufill"></div></div><div class="ux"><span id="uc">0 / 25</span><span>FREE</span></div></div>
  </div>
</div>
<div class="mn">
  <div class="hd"><div class="hl"><div class="hb"><div class="zs">0</div><span id="ml">Claude Sonnet 4</span></div></div><div style="display:flex;align-items:center;gap:8px"><div class="ns" onclick="tn()"><div class="ld" id="nl"></div>NTI</div><span onclick="alert('NTI Scoring: When ON, every AI response is scored across 28 governance KPIs — bias detection, sovereignty enforcement, hedge density, and more. Toggle OFF to chat without scoring.')" style="font-size:11px;color:#5a6275;cursor:pointer;font-family:'IBM Plex Mono',monospace;border:1px solid #252b38;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center">?</span></div></div>
  <div class="ms" id="ms"><div class="mi" id="mi">
    <div class="wc" id="wc"><div class="zl"><img src="/static/favicon.png" alt="0"></div><h2>NTI Control Room</h2><p>Chat with Claude or ChatGPT. Every response scored — 28 governance KPIs, basin detection, sovereignty enforcement.</p><div class="fr">25 FREE MESSAGES · NO API KEY REQUIRED</div></div>
  </div></div>
  <div class="iw"><div class="ib">
    <textarea class="if2" id="inp" placeholder="Message..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();go()}"></textarea>
    <button class="sb2" id="sB" onclick="go()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
  </div></div>
</div>
</div>

<div class="pw" id="pw">
<div class="pc">
  <div class="zl"><img src="/static/favicon.png" alt="0"></div>
  <h2>Free messages used</h2>
  <p>Upgrade for unlimited NTI-scored AI chat. Same API key, full governance scoring.</p>
  <div class="pp">
    <div class="pl sel" onclick="sp(this,'pro')"><div><div class="pn">NTI Pro</div><div class="pd">Unlimited NTI-scored chat · Your API key · Full governance</div></div><div class="pr">$9/mo</div></div>
  </div>
  <button class="pb" id="pB" onclick="co()">Subscribe — $9/mo</button>
  <div class="px" onclick="cp()">Maybe later</div>
</div>
</div>

<script>
const FL=25,SL={pro:'https://buy.stripe.com/test_price_1T2Vq2CbeNJgVBp1sovVhfIh'};
const MD={claude:{l:'Claude Sonnet 4',e:'https://api.anthropic.com/v1/messages',m:'claude-sonnet-4-20250514',p:'sk-ant'},gpt:{l:'GPT-4o',e:'https://api.openai.com/v1/chat/completions',m:'gpt-4o',p:'sk-'}};
const SY='You are a helpful assistant. Be direct, concise, substantive. No preamble, no validation language, no smoothing. Lead with constraints before capabilities. Match the user\'s energy and word count.';
let am='claude',hi=[],nti=true,busy=false,mc=+localStorage.getItem('nti_mc')||0,sp2='pro',paid=localStorage.getItem('nti_p')==='1';

// NTI engine
const EC={meta_talk:{w:2,s:["thread","model","ai","tone","mode","structure","protocol","drift","nti","system","framework","architecture","governance","constraint","basin","layer","engine"],m:["in this thread","the model","ai system"]},identity_stance:{w:1.5,s:["teammate","trust","loyal","personality","identity","believe"],m:["i am","you are","we are"]},inversion_philosophy:{w:1.5,s:["upside","backwards","broken","inverted","civilization","philosophical","meaning","purpose","existential","paradox"],m:["upside down","why do we"]},rhetorical_devices:{w:1,s:["imagine","metaphor","analogy","pretend","picture"],m:["like a","as if","think of it","similar to","reminds me of"]},emotional_charge:{w:1,s:["always","never","insane","incredible","massive","critical","absolutely","impossible","terrible","amazing","beautiful","perfect","guaranteed","everyone","completely"],m:["every single","no doubt"]}};
const IC={imperatives:{w:1.5,s:["do","make","write","build","generate","format","create","send","call","order","buy","install","deploy","implement","execute","run","test","configure","set","move","delete","copy","add","update","fix","verify","validate","enforce","prevent","restrict"],m:[]},constraints:{w:2,s:["size","budget","price","cost","limit","max","min","deadline","must","cannot","require","requires","ensure","prohibit","mandate"],m:["no more than","at least","only if","cannot be","must not"]},step_structure:{w:2,s:["step","first","second","third","next","finally","phase","stage","part","then"],m:[]},decision_requests:{w:1,s:["pick","choose","option","recommend","suggest","which","prefer","decision","select"],m:[]},artifacts_tools:{w:1,s:["pdf","template","website","spreadsheet","document","file","app","tool","code","script","dashboard"],m:[]}};
const SO=new Set(["great","perfect","awesome","absolutely","totally","love","nice","excellent","brilliant","fantastic","wonderful","amazing","good"]);
const SM=["great","perfect","awesome","love that","love it","nice","good point","absolutely","totally","you're right","that's fair","understandable","makes sense","valid","of course","excellent","fantastic","wonderful","amazing"];
const HG=["maybe","perhaps","might","possibly","probably","generally","typically","usually","often","approximately","sort of","kind of","could be"];
const NG=["not","don't","can't","won't","never","no","isn't","aren't","wasn't","weren't","couldn't","shouldn't","neither","nothing"];
const AG=["yes","correct","right","exactly","agreed","true","absolutely","indeed","precisely"];
const CH=["but","however","although","actually","not quite","careful","risk","warning","concern","problem","issue"];
const GR=["because","since","given","therefore","specifically","for example","evidence","data","measured","tested","verified","confirmed"];
const AU=["actually","in fact","research shows","data suggests","technically"];
const FW=new Set(["the","a","an","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","may","might","shall","can","to","of","in","for","on","with","at","by","from","that","this","it","its","and","or","but","if","so","not","no","yes","just","very","really","also","too"]);
const PR=/^(good|great|perfect|absolutely|locked|proceeding|understood|yes|correct|totally|awesome|nice|sure|ok|here's|let's|we'll|that's|you're)/;
function tk(t){return(t||'').toLowerCase().match(/[a-z0-9']+/g)||[];}
function cx(tl,toks,cat){let c=0;for(const s of cat.s)for(const t of toks)if(t===s)c++;for(const m of cat.m){let i=0;while((i=tl.indexOf(m,i))!==-1){c++;i+=m.length;}}return c;}
function cf(tl,ms){let c=0;for(const m of ms){let i=0;while((i=tl.indexOf(m,i))!==-1){c++;i+=m.length;}}return c;}
function sc(text,ht){
  const tl=(text||'').toLowerCase(),toks=tk(text),wc=Math.max(toks.length,1),sents=(text||'').split(/[.!?]+/).filter(s=>s.trim().length>3);
  let ew=0,iw=0;for(const c of Object.values(EC))ew+=cx(tl,toks,c)*c.w;for(const c of Object.values(IC))iw+=cx(tl,toks,c)*c.w;
  const ed=+(ew/wc*1000).toFixed(1),id=+(iw/wc*1000).toFixed(1),bi=+(ed-id).toFixed(1),bn=+Math.tanh(bi/200).toFixed(4);
  const sl=sents.length?+(sents.reduce((a,s)=>a+tk(s).length,0)/sents.length).toFixed(1):0;
  const f3=toks.slice(0,3),osr=f3.some(t=>SO.has(t))?1:0;
  let pbl=0;for(const s of sents){if(PR.test(s.trim().toLowerCase())||tk(s).length<=5)pbl+=tk(s).length;else break;}
  const smd=+(cf(tl,SM)/wc*100).toFixed(1),hedd=+(cf(tl,HG)/wc*100).toFixed(1),negd=+(cf(tl,NG)/wc*100).toFixed(1);
  const snr=+(toks.filter(t=>!FW.has(t)).length/wc).toFixed(3);
  const ag=cf(tl,AG),ch=cf(tl,CH),agree=+(ag/Math.max(ag+ch,1)).toFixed(3);
  const auth=cf(tl,AU),grnd=cf(tl,GR),ctrl=(id/100)+(auth/wc*10),integ=Math.max(0.1,(grnd/wc*10)+0.3),cir=+(ctrl/integ).toFixed(2);
  const plac=+(osr*0.4+Math.min(pbl/30,1)*0.3+Math.min(smd/100,1)*0.3).toFixed(3),sov=plac<0.4;
  const fl=[];if(osr)fl.push('SMOOTH:'+f3.slice(0,2).join(' '));if(pbl>15)fl.push('PREAMBLE:'+pbl);if(cir>1.5)fl.push('OVERSTEER:'+cir);if(!sov)fl.push('OSE_FAIL');
  let lr=null,mirr=null;if(ht){const h2=tk(ht),hs=new Set(h2);lr=+(wc/Math.max(h2.length,1)).toFixed(1);mirr=hs.size?+([...hs].filter(t=>new Set(toks).has(t)).length/hs.size).toFixed(3):0;}
  return{bn,basin:bn>0.1?'ESC':bn<-0.1?'UTL':'NEU',osr,cir,sl,pbl,smd,hedd,negd,snr,agree,sov,fl,lr,mirr};
}

function pick(m){am=m;document.querySelectorAll('.mb').forEach(b=>b.classList.remove('on'));document.getElementById('b-'+m).classList.add('on');document.getElementById('ml').textContent=MD[m].l;document.getElementById('ak').placeholder=MD[m].p+'...';hi=[];const mi=document.getElementById('mi');mi.innerHTML='<div class="wc"><div class="zl"><img src="/static/favicon.png" alt="0"></div><h2>NTI Control Room</h2><p>Chat with '+MD[m].l+'. Every response scored — 28 KPIs.</p><div class="fr">'+Math.max(0,FL-mc)+' FREE MESSAGES LEFT</div></div>';}
function tn(){nti=!nti;document.getElementById('nl').classList.toggle('off',!nti);}
function uu(){const p=Math.min(100,mc/FL*100),f=document.getElementById('ufill');f.style.width=p+'%';f.className='uf'+(p>80?' x':p>60?' w':'');document.getElementById('uc').textContent=mc+' / '+FL;}
function sp(el,plan){document.querySelectorAll('.pl').forEach(p=>p.classList.remove('sel'));el.classList.add('sel');sp2=plan;const pr={starter:'$500/mo',core:'$2,500/mo',pipeline:'$7,500/mo'};document.getElementById('pB').textContent='Subscribe — '+pr[plan];}
function co(){const l=SL[sp2];if(l&&!l.includes('stripe.com/'+sp2)){window.open(l,'_blank');}else{paid=true;localStorage.setItem('nti_p','1');cp();}}
function cp(){document.getElementById('pw').classList.remove('sh');}
function swp(){document.getElementById('pw').classList.add('sh');}
function esc(t){return(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function rs(s){
  if(!nti)return'<div class="ns2 hd2"></div>';
  const c=(l,v,cl)=>`<div class="nc"><span class="l2">${l}</span><span class="v2 ${cl}">${v}</span></div>`;
  let h='<div class="ns2">';
  h+=c('BI',(s.bn>0?'+':'')+s.bn.toFixed(3),s.basin==='UTL'?'g':s.basin==='ESC'?'r':'b');
  h+=c('Basin',s.basin,s.basin==='UTL'?'g':s.basin==='ESC'?'r':'p');
  h+=c('OSE',s.sov?'OK':'FAIL',s.sov?'g':'r');
  h+=c('CIR',s.cir.toFixed(1),s.cir>1.5?'r':s.cir>1?'w':'g');
  h+=c('SL',s.sl.toFixed(0),'m');h+=c('SNR',s.snr,'m');h+=c('PBL',s.pbl,s.pbl>15?'w':'m');
  if(s.lr!==null)h+=c('LR',s.lr+'x',s.lr>50?'r':s.lr>20?'w':'m');
  if(s.osr)h+=c('OSR','⚠','r');if(s.hedd>0)h+=c('HedD',s.hedd,s.hedd>1?'w':'m');if(s.smd>0)h+=c('SmD',s.smd,s.smd>1?'w':'m');
  if(s.fl.length)h+=`<div class="nf">${s.fl.join(' · ')}</div>`;
  return h+'</div>';
}

async function go(){
  const inp=document.getElementById('inp'),text=inp.value.trim();
  if(!text||busy)return;
  if(!paid&&mc>=FL){swp();return;}
  const key=document.getElementById('ak').value.trim();
  const cfg=MD[am];

  const w=document.getElementById('wc');if(w)w.remove();
  const mi=document.getElementById('mi');

  const hd=document.createElement('div');hd.className='m';
  hd.innerHTML=`<div class="mr y">You</div><div class="mb2">${esc(text)}</div>`;
  mi.appendChild(hd);hi.push({role:'user',content:text});
  const ht=text;inp.value='';inp.style.height='auto';
  if(hi.length<=2)document.getElementById('cc').textContent=text.slice(0,35)+(text.length>35?'…':'');

  const ad=document.createElement('div');ad.className='m';
  ad.innerHTML=`<div class="mr">Assistant</div><div class="mb2"><div class="dt"><span></span><span></span><span></span></div></div>`;
  mi.appendChild(ad);
  document.getElementById('ms').scrollTop=document.getElementById('ms').scrollHeight;
  busy=true;document.getElementById('sB').disabled=true;

  try{
    let reply='';
    if(key){
      // User provided their own key — direct API call
      if(am==='claude'){
        const r=await fetch(cfg.e,{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:cfg.m,max_tokens:4096,system:SY,messages:hi})});
        const d=await r.json();reply=d.error?'Error: '+(d.error.message||JSON.stringify(d.error)):d.content.map(c=>c.text||'').join('');
      }else{
        const r=await fetch(cfg.e,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:cfg.m,max_tokens:4096,messages:[{role:'system',content:SY},...hi]})});
        const d=await r.json();reply=d.error?'Error: '+(d.error.message||JSON.stringify(d.error)):d.choices?.[0]?.message?.content||'No response';
      }
    }else{
      // No key — use server proxy (free tier)
      const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:am,messages:hi,system:SY})});
      const d=await r.json();
      if(d.error){reply='Error: '+d.error;}
      else{reply=d.reply||d.content||'No response';}
    }
    hi.push({role:'assistant',content:reply});
    const s=sc(reply,ht);
    ad.innerHTML=`<div class="mr">Assistant</div><div class="mb2">${esc(reply)}</div>${rs(s)}`;
    mc++;localStorage.setItem('nti_mc',mc);uu();
  }catch(err){ad.querySelector('.mb2').textContent='Error: '+err.message;}
  busy=false;document.getElementById('sB').disabled=false;
  document.getElementById('ms').scrollTop=document.getElementById('ms').scrollHeight;
}

document.getElementById('inp').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,180)+'px';});
const sk=localStorage.getItem('nti_ak');if(sk)document.getElementById('ak').value=sk;
document.getElementById('ak').addEventListener('change',function(){localStorage.setItem('nti_ak',this.value);});
if(window.self!==window.top){const n=document.querySelector('[data-shell-nav]');if(n)n.style.display='none';}
uu();
</script>
<script src="/static/nti-engine.js"></script>

<script>
// V3 enforce on AI responses in control room
const _origRender = typeof renderMsg === 'function' ? renderMsg : null;
// Hook: after any AI message is rendered, score it inline
document.addEventListener('nti:ai-response', async (e) => {
  if (e.detail && e.detail.text && e.detail.el) {
    const bar = document.createElement('div');
    bar.style.cssText = 'font-family:monospace;font-size:11px;margin-top:4px;color:#5a6275';
    e.detail.el.appendChild(bar);
    const data = await NTI.score(e.detail.text);
    const nii = data.score?.nii_score ?? data.nii_score ?? 0;
    const color = nii >= 0.8 ? '#00e89c' : nii >= 0.5 ? '#f59e0b' : '#ef4444';
    bar.innerHTML = `NTI <span style="color:${color};font-weight:700">${(nii*100).toFixed(0)}</span>`;
  }
});
</script>

<script src="/static/az-shell.js"></script>
</body>
</html>
