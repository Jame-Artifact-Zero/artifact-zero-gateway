{% extends "base.html" %}
{% block title %}Contact — Artifact Zero{% endblock %}
{% block body_class %}page-contact{% endblock %}

{% block head %}
<style>
.form-wrap{max-width:520px;margin:0 auto;padding:100px 20px 60px;min-height:80vh;display:flex;flex-direction:column;justify-content:center}
.form-wrap h1{font-family:var(--az-mono);font-size:22px;font-weight:700;margin-bottom:6px}
.form-wrap .sub{color:var(--muted);font-size:14px;margin-bottom:28px;line-height:1.5}
.field{margin-bottom:16px}
.field label{display:block;font-family:var(--az-mono);font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.field input,.field textarea{width:100%;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--az-sans);font-size:15px;outline:none;transition:border .2s}
.field input:focus,.field textarea:focus{border-color:var(--accent)}
.field textarea{min-height:120px;resize:vertical;line-height:1.6}
.field input::placeholder,.field textarea::placeholder{color:#3d4452}
.send-btn{width:100%;padding:14px;border:none;border-radius:8px;background:var(--accent);color:#000;font-family:var(--az-sans);font-size:15px;font-weight:700;cursor:pointer;transition:all .15s;margin-top:8px}
.send-btn:hover{background:#00d48c}
.send-btn:disabled{background:var(--surface2);color:var(--muted);cursor:default}

/* V3 panel */
.v3-panel{display:none;margin-top:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.v3-panel.show{display:block;animation:slideUp .25s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.v3-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.v3-title{font-family:var(--az-mono);font-size:11px;letter-spacing:1.5px;color:var(--accent)}
.v3-stats{font-family:var(--az-mono);font-size:10px;color:var(--muted)}
.v3-action{padding:8px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;font-size:12px}
.v3-action-type{font-family:var(--az-mono);font-size:10px;font-weight:600;color:var(--amber);text-transform:uppercase;letter-spacing:.5px;min-width:80px}
.v3-action-detail{color:var(--muted);flex:1;line-height:1.4}
.v3-cleaned{padding:16px;font-size:14px;line-height:1.7;color:var(--text)}
.v3-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
.v3-btn{flex:1;padding:10px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--az-sans);text-align:center;transition:all .15s}
.v3-use{background:var(--accent);color:#0a0c10}.v3-use:hover{background:#00d48c}
.v3-keep{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}.v3-keep:hover{color:var(--accent);border-color:var(--accent)}

.sent-wrap{display:none;max-width:520px;margin:0 auto;padding:100px 20px;text-align:center}
.sent-wrap.show{display:block;animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
</style>
{% endblock %}

{% block content %}
<div class="form-wrap" id="formWrap">
  <h1>Say something</h1>
  <div class="sub">Your message runs through V3 structural enforcement before we read it. You'll see what it catches.</div>
  <div class="field"><label>Name</label><input type="text" id="nameField" placeholder="Your name" autocomplete="name"></div>
  <div class="field"><label>Email</label><input type="email" id="emailField" placeholder="you@company.com" autocomplete="email"></div>
  <div class="field"><label>Message</label><textarea id="msgField" placeholder="What's on your mind?"></textarea></div>
  <div class="v3-panel" id="v3Panel"></div>
  <button class="send-btn" id="sendBtn" onclick="handleSend()">Send</button>
</div>
<div class="sent-wrap" id="sentWrap">
  <div style="font-size:48px;opacity:.5;margin-bottom:12px">&#9989;</div>
  <div style="font-family:var(--az-mono);font-size:18px;color:var(--accent);letter-spacing:2px;margin-bottom:8px">SENT</div>
  <div style="font-size:14px;color:var(--muted);line-height:1.6">Your message was delivered. If you left an email, we'll get back to you.</div>
</div>
{% endblock %}

{% block scripts %}
<script>
let v3Result=null,v3Applied=false;
async function handleSend(){
  const name=document.getElementById('nameField').value.trim(),email=document.getElementById('emailField').value.trim(),msg=document.getElementById('msgField').value.trim(),btn=document.getElementById('sendBtn');
  if(!name||!email||!msg){btn.textContent='All fields required';setTimeout(()=>{btn.textContent='Send'},2000);return}
  if(!v3Result&&msg.length>20){
    btn.disabled=true;btn.textContent='Running V3…';
    try{const res=await fetch('/api/v1/contact-enforce',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});const data=await res.json();v3Result=data;
      if(data.changed&&data.action_count>0){renderV3(data);btn.textContent='Send original';btn.disabled=false;return}
    }catch(e){}
  }
  const messageToSend=v3Applied?v3Result.cleaned:msg;
  btn.disabled=true;btn.textContent='Sending…';
  try{const res=await fetch('/api/contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,message:messageToSend})});const data=await res.json();
    if(data.status==='ok'||res.ok){document.getElementById('formWrap').style.display='none';document.getElementById('sentWrap').classList.add('show')}
    else{btn.textContent=data.error||'Error';btn.disabled=false}
  }catch(e){btn.textContent='Network error';btn.disabled=false}
}
function renderV3(data){
  const panel=document.getElementById('v3Panel');let h='<div class="v3-header"><span class="v3-title">V3 ENFORCEMENT</span><span class="v3-stats">'+data.action_count+' change'+(data.action_count!==1?'s':'')+' · '+data.elapsed_ms+'ms</span></div>';
  const labels={filler_removal:'Filler',hedge_removal:'Hedge',smooth_opener_strip:'Opener',time_collapse:'Planning',redundancy_compression:'Duplicate',escalation_strip:'Escalation',dominance_neutralization:'Dominance',defensive_neutralization:'Defensive'};
  data.actions.forEach(a=>{h+='<div class="v3-action"><span class="v3-action-type">'+(labels[a.check]||a.check)+'</span><span class="v3-action-detail">'+esc(a.detail)+'</span></div>'});
  h+='<div class="v3-cleaned">'+esc(data.cleaned)+'</div><div class="v3-footer"><button class="v3-btn v3-use" onclick="useV3()">Use cleaned version</button><button class="v3-btn v3-keep" onclick="keepOriginal()">Keep my original</button></div>';
  panel.innerHTML=h;panel.className='v3-panel show';
}
function useV3(){if(!v3Result)return;document.getElementById('msgField').value=v3Result.cleaned;v3Applied=true;document.getElementById('v3Panel').className='v3-panel';document.getElementById('sendBtn').textContent='Send';handleSend()}
function keepOriginal(){v3Applied=false;document.getElementById('v3Panel').className='v3-panel';document.getElementById('sendBtn').textContent='Send';handleSend()}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
</script>
{% endblock %}
