{% extends "base.html" %}
{% block title %}Fortune 500 Structure Check — Artifact Zero{% endblock %}
{% block body_class %}page-fortune500{% endblock %}

{% block head %}
<style>


/* Hero */
.hero{padding:90px 20px 24px;text-align:center;max-width:700px;margin:0 auto}
.hero h1{font-size:clamp(24px,5vw,40px);font-weight:700;line-height:1.2;margin-bottom:10px}
.hero h1 .num{color:var(--accent);font-family:var(--az-mono)}
.hero .sub{font-size:14px;color:var(--muted);line-height:1.6}

/* Stats bar */
.stats{display:flex;justify-content:center;gap:24px;padding:16px 20px 20px;flex-wrap:wrap}
.stat{text-align:center}
.stat-val{font-family:var(--az-mono);font-size:22px;font-weight:700;color:var(--accent)}
.stat-label{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:2px}

/* Search + Filter */
.controls{max-width:700px;margin:0 auto 20px;padding:0 16px}
.search-box{width:100%;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:var(--az-sans);outline:none;transition:border-color .15s}
.search-box:focus{border-color:var(--accent)}
.search-box::placeholder{color:#3d4452}
.filter-row{display:flex;gap:8px;margin-top:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px}
.filter-btn{padding:6px 14px;border-radius:6px;font-family:var(--az-mono);font-size:10px;letter-spacing:1px;background:var(--surface);border:1px solid var(--border);color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.filter-btn:hover{border-color:var(--accent);color:var(--accent)}
.filter-btn.active{background:var(--accent);color:#0a0c10;border-color:var(--accent)}

/* Company list */
.list{max-width:700px;margin:0 auto;padding:0 16px 40px}
.company-card{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;text-decoration:none;color:var(--text);transition:all .15s;cursor:pointer}
.company-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.company-card:active{transform:translateY(0)}

/* Rank */
.card-rank{font-family:var(--az-mono);font-size:11px;font-weight:700;color:var(--muted);width:28px;text-align:center;flex-shrink:0}

/* Score circle */
.card-score{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:2px solid}
.card-score .val{font-family:var(--az-mono);font-size:14px;font-weight:700}
.card-score.good{border-color:var(--accent)}.card-score.good .val{color:var(--accent)}
.card-score.mid{border-color:var(--amber)}.card-score.mid .val{color:var(--amber)}
.card-score.bad{border-color:var(--red)}.card-score.bad .val{color:var(--red)}

/* Info */
.card-info{flex:1;min-width:0}
.card-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-detail{font-size:11px;color:var(--muted);margin-top:2px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.card-issues{font-family:var(--az-mono);font-size:10px;padding:2px 6px;border-radius:3px}
.card-issues.has-issues{background:#7f1d1d;color:#fca5a5}
.card-issues.clear{background:#064e3b;color:#86efac}
.card-label{font-family:var(--az-mono);font-size:9px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase}

/* Arrow */
.card-arrow{color:var(--border);font-size:16px;flex-shrink:0;transition:color .15s}
.company-card:hover .card-arrow{color:var(--accent)}

/* Empty state */
.empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px}

/* Bottom CTA */
.bottom-cta{text-align:center;padding:40px 20px 60px;max-width:500px;margin:0 auto}
.bottom-cta p{font-size:14px;color:var(--muted);margin-bottom:16px;line-height:1.6}
.bottom-cta a{display:inline-block;padding:12px 28px;background:var(--accent);color:#0a0c10;border-radius:8px;font-size:14px;font-weight:700;text-decoration:none;transition:background .15s}
.bottom-cta a:hover{background:#00d48c}

/* Loading */
.loading{text-align:center;padding:40px;font-family:var(--az-mono);font-size:12px;color:var(--muted)}

/* Page nav tabs */
.page-tabs{display:flex;justify-content:center;gap:8px;padding:70px 16px 0}
.page-tab{padding:8px 20px;border-radius:6px;font-family:var(--az-mono);font-size:11px;letter-spacing:1px;text-decoration:none;transition:all .15s}
.page-tab.inactive{background:var(--surface);border:1px solid var(--border);color:var(--muted)}
.page-tab.inactive:hover{border-color:var(--accent);color:var(--accent)}
.page-tab.active{background:var(--accent);color:#0a0c10;border:1px solid var(--accent);font-weight:700}

@media(max-width:500px){
  .company-card{padding:12px;gap:10px}
  .card-rank{width:22px;font-size:10px}
  .card-score{width:42px;height:42px}
  .card-score .val{font-size:12px}
  .card-name{font-size:13px}
  .stats{gap:16px}
  .stat-val{font-size:18px}
}
</style>
{% endblock %}

{% block content %}
<div class="page-tabs">
  <a href="/fortune500" class="page-tab active">FORTUNE 500</a>
  <a href="/vc-funds" class="page-tab inactive">VC FUNDS</a>
</div>

<div class="hero">
  <h1>Fortune <span class="num">500</span> Structure Check</h1>
  <div class="sub">Every homepage. Scored. Updated daily. Same engine. Same rules. No opinion.</div>
</div>

<div class="stats" id="stats">
  <div class="stat"><div class="stat-val" id="statTotal">—</div><div class="stat-label">Companies</div></div>
  <div class="stat"><div class="stat-val" id="statAvg">—</div><div class="stat-label">Avg Score</div></div>
  <div class="stat"><div class="stat-val" id="statClear">—</div><div class="stat-label">Clean</div></div>
  <div class="stat"><div class="stat-val" id="statIssues">—</div><div class="stat-label">With Issues</div></div>
</div>

<div class="controls">
  <input type="text" class="search-box" id="searchBox" placeholder="Search company name..." autocomplete="off">
  <div class="filter-row">
    <button class="filter-btn active" data-filter="all">ALL</button>
    <button class="filter-btn" data-filter="good">SCORE 70%+</button>
    <button class="filter-btn" data-filter="mid">SCORE 45-69%</button>
    <button class="filter-btn" data-filter="bad">SCORE &lt;45%</button>
    <button class="filter-btn" data-filter="issues">HAS ISSUES</button>
  </div>
</div>

<div class="list" id="companyList">
  <div class="loading">Loading scores...</div>
</div>

<div class="bottom-cta">
  <p>Do you work for one of these companies? Do you buy from one? Do you compete with one?</p>
  <a href="/safecheck">Check your own words &rarr;</a>
</div>

<script src="/static/az-mobile-audit.js" data-mode="silent"></script>
{% endblock %}

{% block scripts %}
<script>
let allCompanies = [];

async function loadScores(){
  try {
    const res = await fetch('/api/fortune500');
    const data = await res.json();
    allCompanies = data.companies || [];
    updateStats();
    renderList(allCompanies);
  } catch(e){
    document.getElementById('companyList').innerHTML = '<div class="empty">Scores loading. Check back soon.</div>';
  }
}

function updateStats(){
  const total = allCompanies.length;
  const scores = allCompanies.map(c => c.csi_score || c.nii_score || 0);
  const avg = total ? (scores.reduce((s,v) => s + v, 0) / total) : 0;
  const clear = allCompanies.filter(c => (c.findings_count || c.issue_count || 0) === 0).length;
  const issues = total - clear;
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statAvg').textContent = avg.toFixed(1) + '%';
  document.getElementById('statClear').textContent = clear;
  document.getElementById('statIssues').textContent = issues;
}

function scoreClass(score){
  if(score >= 70) return 'good';
  if(score >= 45) return 'mid';
  return 'bad';
}

function renderList(companies){
  const el = document.getElementById('companyList');
  if(!companies.length){
    el.innerHTML = '<div class="empty">No companies match your search.</div>';
    return;
  }
  el.innerHTML = companies.map(c => {
    const score = c.csi_score || c.nii_score || 0;
    const cls = scoreClass(score);
    const findings = c.findings_count || c.issue_count || 0;
    const label = c.csi_label || '';
    const checked = c.last_checked ? new Date(c.last_checked).toLocaleDateString() : '';
    return `
      <a class="company-card" href="/scored/${c.slug}" data-score="${score}" data-findings="${findings}">
        <div class="card-rank">${c.rank || '—'}</div>
        <div class="card-score ${cls}"><span class="val">${score.toFixed(1)}</span></div>
        <div class="card-info">
          <div class="card-name">${c.company_name}</div>
          <div class="card-detail">
            <span class="card-label">${label}</span>
            <span class="card-issues ${findings>0?'has-issues':'clear'}">${findings>0?findings+' finding'+(findings>1?'s':''):'CLEAR'}</span>
            ${checked ? '<span>'+checked+'</span>' : ''}
          </div>
        </div>
        <span class="card-arrow">&rsaquo;</span>
      </a>
    `;
  }).join('');
}

// Search
document.getElementById('searchBox').addEventListener('input', function(){
  const q = this.value.toLowerCase().trim();
  const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
  const filtered = filterCompanies(allCompanies, activeFilter).filter(c =>
    c.company_name.toLowerCase().includes(q) || c.slug.includes(q)
  );
  renderList(filtered);
});

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function(){
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    const q = document.getElementById('searchBox').value.toLowerCase().trim();
    let filtered = filterCompanies(allCompanies, this.dataset.filter);
    if(q) filtered = filtered.filter(c => c.company_name.toLowerCase().includes(q));
    renderList(filtered);
  });
});

function filterCompanies(list, filter){
  switch(filter){
    case 'good': return list.filter(c => (c.csi_score||c.nii_score||0) >= 70);
    case 'mid': return list.filter(c => {const s=c.csi_score||c.nii_score||0; return s>=45&&s<70;});
    case 'bad': return list.filter(c => (c.csi_score||c.nii_score||0) < 45);
    case 'issues': return list.filter(c => (c.findings_count||c.issue_count||0) > 0);
    default: return list;
  }
}

loadScores();
</script>

{% endblock %}
