{% extends "base.html" %}
{% block title %}TALK — Voice to Structure{% endblock %}
{% block body_class %}voice-page{% endblock %}

{% block head %}
<style>
/* =============================================
   TALK — Voice-to-Structure Interface
   Artifact Zero Labs | a0_voice_p001_v2_f2
   Route: /voice
   ============================================= */

/* Override base.html main padding for full-bleed layout */
.voice-page .az-main { padding: 0; max-width: 100%; }
.voice-page footer, .voice-page .az-footer { display: none; }
.voice-page .az-bottom-nav { display: none; }

/* Voice-specific variables (layer on top of az-base.css) */
:root {
  --v-signal: #00ff88;
  --v-ramble: #f59e0b;
  --v-action: #3b82f6;
  --v-clean: #a78bfa;
  --v-raw: #6b7280;
  --v-edge: #ef4444;
  --v-hedge: #f97316;
  --v-glow-sig: rgba(0,255,136,0.06);
  --v-glow-act: rgba(59,130,246,0.06);
}

/* EDGE WARNING BAR */
.v-edge-bar {
  height: 3px; background: transparent;
  transition: background 0.5s; flex-shrink: 0;
}
.v-edge-bar.hot {
  background: linear-gradient(90deg, transparent, var(--v-edge), transparent);
  animation: v-edge-pulse 1.5s infinite;
}
@keyframes v-edge-pulse { 0%,100%{opacity:.4} 50%{opacity:1} }

/* LAYOUT WRAPPER — fills viewport below base.html topbar */
.v-wrap {
  display: flex; flex-direction: column;
  height: calc(100vh - 56px);
  height: calc(100dvh - 56px);
}

/* INPUT BAR */
.v-input {
  display: flex; align-items: center; padding: 10px 16px; gap: 10px;
  border-bottom: 1px solid var(--border, #252a35);
  flex-shrink: 0; background: var(--bg, #0a0c10);
}
.v-mic {
  width: 44px; height: 44px; border-radius: 50%;
  border: 2px solid var(--border, #252a35);
  background: var(--surface, #12151b);
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.3s; position: relative; flex-shrink: 0;
}
.v-mic:hover { border-color: var(--v-signal); }
.v-mic.active {
  border-color: var(--v-signal);
  background: rgba(0,255,136,0.08);
  box-shadow: 0 0 16px rgba(0,255,136,0.12);
}
.v-mic.active::after {
  content: ''; position: absolute; inset: -5px; border-radius: 50%;
  border: 1px solid rgba(0,255,136,0.25); animation: v-pulse 2s infinite;
}
@keyframes v-pulse { 0%,100%{transform:scale(1);opacity:.5} 50%{transform:scale(1.12);opacity:0} }
.v-mic-dot {
  width: 12px; height: 12px; border-radius: 50%;
  background: var(--muted, #6b7280); transition: background 0.3s;
}
.v-mic.active .v-mic-dot { background: var(--v-signal); }
.v-mic.off { opacity: 0.25; cursor: default; }

.v-ta {
  flex: 1; background: var(--surface, #12151b);
  border: 1px solid var(--border, #252a35);
  color: var(--text, #e8eaf0); padding: 8px 12px; border-radius: 6px;
  font-family: 'DM Sans', sans-serif; font-size: 14px; line-height: 1.5;
  resize: none; outline: none; transition: border 0.2s;
  min-height: 38px; max-height: 80px;
}
.v-ta:focus { border-color: var(--v-signal); }
.v-ta::placeholder { color: var(--dim, #3d4452); }

.v-go {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: var(--v-signal); background: rgba(0,255,136,0.06);
  border: 1px solid rgba(0,255,136,0.2);
  padding: 8px 12px; border-radius: 4px; cursor: pointer;
  letter-spacing: 1px; transition: all 0.2s; flex-shrink: 0;
}
.v-go:hover { background: rgba(0,255,136,0.12); border-color: var(--v-signal); }

.v-clr {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: var(--muted, #6b7280); background: transparent;
  border: 1px solid var(--border, #252a35);
  padding: 8px 10px; border-radius: 4px; cursor: pointer;
  letter-spacing: 1px; transition: all 0.2s; flex-shrink: 0;
}
.v-clr:hover { border-color: var(--v-edge); color: var(--v-edge); }

/* STATS ROW */
.v-stats {
  display: flex; align-items: center; justify-content: flex-end;
  padding: 4px 16px; gap: 14px;
  background: var(--surface2, #1a1e27);
  border-bottom: 1px solid var(--border, #252a35);
  flex-shrink: 0;
}
.v-stat {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  color: var(--muted, #6b7280); letter-spacing: 0.5px;
}
.v-stat b { color: var(--text, #e8eaf0); font-weight: 500; }

/* MOBILE TABS */
.v-mtabs {
  display: none; overflow-x: auto;
  background: var(--surface2, #1a1e27);
  border-bottom: 1px solid var(--border, #252a35);
  flex-shrink: 0; -webkit-overflow-scrolling: touch; scrollbar-width: none;
}
.v-mtabs::-webkit-scrollbar { display: none; }
.v-mt {
  font-family: 'JetBrains Mono', monospace; font-size: 10px; letter-spacing: 1px;
  padding: 8px 14px; white-space: nowrap; color: var(--muted, #6b7280);
  border-bottom: 2px solid transparent; cursor: pointer;
  transition: all 0.2s; flex-shrink: 0;
}
.v-mt.on { color: var(--text, #e8eaf0); border-bottom-color: currentColor; }
.v-mt[data-p="raw"].on { color: var(--v-raw); }
.v-mt[data-p="signal"].on { color: var(--v-signal); }
.v-mt[data-p="ramble"].on { color: var(--v-ramble); }
.v-mt[data-p="action"].on { color: var(--v-action); }
.v-mt[data-p="clean"].on { color: var(--v-clean); }

/* PANE GRID */
.v-grid {
  display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr 1fr;
  gap: 1px; background: var(--border, #252a35); flex: 1; overflow: hidden;
}
.v-pn {
  background: var(--surface, #12151b);
  display: flex; flex-direction: column; overflow: hidden; min-height: 0;
}
.v-pn[data-p="raw"] { grid-row: 1 / 3; }

.v-ph {
  display: flex; align-items: center; justify-content: space-between;
  padding: 7px 12px; background: var(--surface2, #1a1e27);
  border-bottom: 1px solid var(--border, #252a35); flex-shrink: 0;
}
.v-pt {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  font-weight: 600; letter-spacing: 2px; text-transform: uppercase;
}
.v-pc { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--muted, #6b7280); }
.v-pb {
  flex: 1; overflow-y: auto; padding: 10px 12px;
  font-size: 13.5px; line-height: 1.65; font-family: 'DM Sans', sans-serif;
  scroll-behavior: smooth;
}
.v-pb::-webkit-scrollbar { width: 4px; }
.v-pb::-webkit-scrollbar-track { background: transparent; }
.v-pb::-webkit-scrollbar-thumb { background: var(--border, #252a35); border-radius: 2px; }

.v-pn[data-p="raw"] .v-pt { color: var(--v-raw); }
.v-pn[data-p="signal"] .v-pt { color: var(--v-signal); }
.v-pn[data-p="ramble"] .v-pt { color: var(--v-ramble); }
.v-pn[data-p="action"] .v-pt { color: var(--v-action); }
.v-pn[data-p="clean"] .v-pt { color: var(--v-clean); }

/* WORD CLASSES */
.vw { transition: color 0.3s; }
.vw-hedge { color: var(--v-hedge); opacity: 0.7; }
.vw-filler { color: var(--muted, #6b7280); opacity: 0.5; }
.vw-action { color: var(--v-action); font-weight: 500; }
.vw-interim { color: var(--muted, #6b7280); font-style: italic; }

/* PANE ITEMS */
.v-sig {
  padding: 6px 8px; margin-bottom: 5px;
  border-left: 2px solid var(--v-signal); background: var(--v-glow-sig);
  border-radius: 0 4px 4px 0; font-size: 13px; animation: v-si 0.3s ease;
}
.v-ram {
  padding: 4px 8px; margin-bottom: 4px;
  color: var(--v-ramble); opacity: 0.7; font-size: 12px;
  font-style: italic; animation: v-fi 0.5s ease;
}
.v-act {
  padding: 6px 8px; margin-bottom: 5px;
  border-left: 2px solid var(--v-action); background: var(--v-glow-act);
  border-radius: 0 4px 4px 0; font-size: 13px;
  display: flex; align-items: flex-start; gap: 8px; animation: v-si 0.3s ease;
}
.v-an {
  color: var(--v-action); font-family: 'JetBrains Mono', monospace;
  font-size: 11px; font-weight: 600; flex-shrink: 0; margin-top: 1px;
}
.v-cln { color: var(--text, #e8eaf0); line-height: 1.75; }
.v-emp {
  display: flex; align-items: center; justify-content: center;
  height: 100%; color: var(--muted, #6b7280);
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  letter-spacing: 1px; text-align: center; padding: 20px;
}

/* EXPORT BAR */
.v-xp {
  display: flex; gap: 6px; padding: 6px 12px;
  background: var(--surface2, #1a1e27);
  border-top: 1px solid var(--border, #252a35); flex-shrink: 0;
}
.v-xb {
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  color: var(--muted, #6b7280); background: transparent;
  border: 1px solid var(--border, #252a35);
  padding: 4px 8px; border-radius: 3px; cursor: pointer;
  letter-spacing: 0.5px; transition: all 0.2s;
}
.v-xb:hover { border-color: var(--v-signal); color: var(--v-signal); }
.v-xb.ok { border-color: var(--v-signal); color: var(--v-signal); }

@keyframes v-si { from{transform:translateX(-8px);opacity:0} to{transform:translateX(0);opacity:1} }
@keyframes v-fi { from{opacity:0} to{opacity:1} }

/* MOBILE */
@media (max-width: 768px) {
  .v-wrap { height: calc(100vh - 52px); height: calc(100dvh - 52px); }
  .v-mtabs { display: flex; }
  .v-grid { display: flex; flex-direction: column; background: var(--bg, #0a0c10); gap: 0; }
  .v-pn { display: none; flex: 1; }
  .v-pn.on { display: flex; }
  .v-pn .v-ph { display: none; }
  .v-stats { display: none; }
  .v-ta { font-size: 16px; }
}
</style>
{% endblock %}

{% block content %}
<div class="v-edge-bar" id="vEdge"></div>
<div class="v-wrap">

  <!-- INPUT -->
  <div class="v-input">
    <button class="v-mic" id="vMic" title="Voice capture"><div class="v-mic-dot"></div></button>
    <textarea class="v-ta" id="vTa" placeholder="Type, paste, or tap mic to talk" rows="1"></textarea>
    <button class="v-go" id="vGo">GO</button>
    <button class="v-clr" id="vClr">CLR</button>
  </div>

  <!-- STATS -->
  <div class="v-stats">
    <span class="v-stat">WORDS <b id="vSw">0</b></span>
    <span class="v-stat">SIGNAL <b id="vSr">—</b></span>
    <span class="v-stat">EDGE <b id="vSe">0.00</b></span>
  </div>

  <!-- MOBILE TABS -->
  <div class="v-mtabs">
    <div class="v-mt on" data-p="raw">RAW</div>
    <div class="v-mt" data-p="signal">SIGNAL</div>
    <div class="v-mt" data-p="ramble">RAMBLE</div>
    <div class="v-mt" data-p="action">ACTION</div>
    <div class="v-mt" data-p="clean">CLEAN</div>
  </div>

  <!-- PANE GRID -->
  <div class="v-grid">
    <div class="v-pn on" data-p="raw">
      <div class="v-ph"><span class="v-pt">RAW STREAM</span><span class="v-pc" id="vCr">0</span></div>
      <div class="v-pb" id="vBr"><div class="v-emp">Tap mic or type to begin</div></div>
    </div>
    <div class="v-pn" data-p="signal">
      <div class="v-ph"><span class="v-pt">SIGNAL</span><span class="v-pc" id="vCs">0</span></div>
      <div class="v-pb" id="vBs"><div class="v-emp">Core points extracted here</div></div>
    </div>
    <div class="v-pn" data-p="ramble">
      <div class="v-ph"><span class="v-pt">RAMBLE</span><span class="v-pc" id="vCm">0</span></div>
      <div class="v-pb" id="vBm"><div class="v-emp">Filler and repetition caught here</div></div>
    </div>
    <div class="v-pn" data-p="action">
      <div class="v-ph"><span class="v-pt">ACTIONS</span><span class="v-pc" id="vCa">0</span></div>
      <div class="v-pb" id="vBa"><div class="v-emp">Tasks and commitments land here</div></div>
    </div>
    <div class="v-pn" data-p="clean">
      <div class="v-ph"><span class="v-pt">CLEAN</span><span class="v-pc" id="vCc">0</span></div>
      <div class="v-pb" id="vBc"><div class="v-emp">Compressed output appears here</div></div>
    </div>
  </div>

  <!-- EXPORT -->
  <div class="v-xp">
    <button class="v-xb" data-c="raw">COPY RAW</button>
    <button class="v-xb" data-c="signal">COPY SIGNAL</button>
    <button class="v-xb" data-c="action">COPY ACTIONS</button>
    <button class="v-xb" data-c="clean">COPY CLEAN</button>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* =============================================
   NTI VOICE ENGINE — Client-side, Deterministic
   No LLM. Ports v2_engine + v3_engine + edge_engine.
   a0_voice_p001_v2_f2
   ============================================= */
(function(){
'use strict';

// --- NTI DETECTION LISTS ---
var HEDGE=["maybe","likely","possibly","kind of","sort of","probably","might","perhaps","i think","i guess","i suppose"];
var FILL=["um","uh","like","you know","basically","actually","literally","right","so","well","anyway","i mean","honestly","obviously"];
var FILL_PH=["it is important to note","in conclusion","ultimately","to summarize","at the end of the day","the thing is","what i'm trying to say","long story short","if that makes sense","does that make sense","know what i mean","to be honest","to be fair"];
var ACT_T=["i need to","we need to","we should","i should","don't forget to","remind me to","remind me","make sure to","have to","got to","gotta","need to call","need to email","need to text","need to send","need to build","need to fix","need to check","need to update","schedule a","set up a","follow up with","follow up on","action item","to do","todo","next step"];
var ACT_V=["create","analyze","explain","summarize","define","build","calculate","design","review","draft","write","generate","compare","audit","test","fix","deploy","launch","call","email","send","schedule","update","check","ship","push","merge"];
var E_PAT={r:[/\byou\s+were\s+wrong\b/i,/\byou\s+made\s+(a|the)\s+mistake\b/i,/\bthat\s+was\s+your\s+fault\b/i],v:[/\byou\s+(misunderstood|missed|failed)\b/i,/\byou\s+don'?t\s+get\b/i,/\blet\s+me\s+be\s+clear\b/i],e:[/\bthe\s+(real\s+)?issue\s+is\b/i,/\bhere'?s\s+the\s+problem\b/i],d:[/\byou\s+need\s+to\b/i,/\byou\s+have\s+to\b/i,/\byou\s+can'?t\b/i],a:[/\bactually\b/i,/\bclearly\b/i,/\bobviously\b/i]};
var E_W={r:0.25,v:0.20,e:0.15,d:0.10,a:0.15};

// --- STATE ---
var S={on:false,rec:null,raw:'',sents:[],sigs:[],rams:[],acts:[],clean:'',edge:0,recent:[],interim:'',hasMic:false};

// --- CLASSIFIERS ---
function esc(x){return new RegExp('\\b'+x.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','gi');}
function clsW(w){var l=w.toLowerCase().replace(/[^a-z'\-]/g,'');if(HEDGE.includes(l))return'hedge';if(FILL.includes(l))return'filler';if(ACT_V.includes(l))return'action';return'';}
function isAct(s){var l=s.toLowerCase();return ACT_T.some(function(t){return l.includes(t);});}
function exAct(s){var l=s.toLowerCase();for(var i=0;i<ACT_T.length;i++){var x=l.indexOf(ACT_T[i]);if(x!==-1)return s.substring(x).replace(/^(i |we |don't forget to |remind me to |make sure to |have to |got to |gotta )/i,'').trim();}return s;}
function hasSub(s){
  var l=s.toLowerCase(),ws=l.split(/\s+/).filter(function(w){return w.length>2;});
  if(ws.length<3)return false;
  var hA=ACT_V.some(function(v){return l.includes(v);}),hN=/\d/.test(s),hP=/[A-Z][a-z]{2,}/.test(s.substring(1));
  var fc=0;FILL.concat(HEDGE).forEach(function(f){if(l.includes(f))fc++;});
  var fd=fc/ws.length;
  if(fd>0.3)return false;
  if(hA||hN||hP)return true;
  if(ws.length>=6&&fd<0.15)return true;
  return false;
}
function isRam(s,rc){
  var l=s.toLowerCase(),ws=l.split(/\s+/).filter(function(w){return w.length>2;});
  var fc=0;FILL.concat(HEDGE).forEach(function(f){var rx=new RegExp('\\b'+f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','gi');var m=l.match(rx);if(m)fc+=m.length;});
  if(ws.length>0&&fc/ws.length>0.35)return true;
  if(ws.length<=2&&ws.length>0)return true;
  if(rc.length>0){var cw=new Set(ws);for(var i=Math.max(0,rc.length-5);i<rc.length;i++){var pw=new Set(rc[i].toLowerCase().split(/\s+/).filter(function(w){return w.length>2;}));var ol=0;cw.forEach(function(w){if(pw.has(w))ol++;});if(pw.size>0&&ol/Math.max(cw.size,1)>0.6)return true;}}
  return false;
}
function compEdge(t){var tg=new Set();Object.keys(E_PAT).forEach(function(n){E_PAT[n].forEach(function(p){if(p.test(t))tg.add(n);});});var v=0;tg.forEach(function(n){v+=E_W[n]||0;});return Math.min(1,v);}
function strip(t){
  var c=t;
  FILL_PH.forEach(function(p){c=c.replace(new RegExp(p.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'),'');});
  FILL.forEach(function(f){c=c.replace(new RegExp('^'+f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b\\s*','gi'),'');c=c.replace(new RegExp('\\b'+f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b\\s*,?\\s*','gi'),' ');});
  HEDGE.forEach(function(h){c=c.replace(new RegExp('\\b'+h.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b\\s*','gi'),'');});
  return c.replace(/\s+/g,' ').replace(/^\s*[,;]\s*/,'').replace(/\s+([,;.])/g,'$1').trim();
}

// --- PROCESS ---
function procS(s){
  var t=s.trim();if(!t||t.length<3)return;
  S.sents.push(t);
  if(isAct(t)){var a=exAct(t);if(a.length>2){S.acts.push(a);draw('action');}}
  if(isRam(t,S.recent)){S.rams.push(t);draw('ramble');}
  else if(hasSub(t)){S.sigs.push(t);draw('signal');}
  S.recent.push(t);if(S.recent.length>10)S.recent.shift();
  S.edge=compEdge(S.raw);rebCln();upSt();
}
function procAll(text){
  S.raw=text;S.sents=[];S.sigs=[];S.rams=[];S.acts=[];S.recent=[];S.clean='';S.edge=0;
  text.split(/[.!?]+\s*|\n/).filter(function(s){return s.trim().length>2;}).forEach(function(s){procS(s);});
  draw('raw');draw('signal');draw('ramble');draw('action');rebCln();upSt();
}
function appSp(nw){
  S.raw+=nw;
  var ss=S.raw.split(/[.!?]+\s*|\n/).filter(function(s){return s.trim().length>2;});
  for(var i=S.sents.length;i<ss.length;i++)procS(ss[i]);
  if(ss.length<=S.sents.length&&nw.trim().length>10)procS(nw.trim());
  draw('raw');
}
function rebCln(){
  var seen=new Set(),out=[];
  S.sents.forEach(function(s){if(isRam(s,[])&&!isAct(s))return;var cl=strip(s);if(cl.length<5)return;var k=cl.toLowerCase().replace(/[^a-z0-9]/g,'');if(seen.has(k))return;seen.add(k);out.push(cl);});
  S.clean=out.join('. ').replace(/\.\./g,'.').replace(/\s+/g,' ').trim();
  draw('clean');
}

// --- RENDER ---
function h(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function draw(w){
  if(w==='raw'){
    var b=document.getElementById('vBr'),ws=S.raw.split(/\s+/).filter(function(w){return w;});
    var x='';ws.forEach(function(word){var c=clsW(word);x+='<span class="vw'+(c?' vw-'+c:'')+'">' +h(word)+'</span> ';});
    if(S.interim)x+='<span class="vw vw-interim">'+h(S.interim)+'</span>';
    b.innerHTML=x||'<div class="v-emp">Tap mic or type to begin</div>';
    document.getElementById('vCr').textContent=ws.length+' words';
    b.scrollTop=b.scrollHeight;
  }
  if(w==='signal'){
    var b=document.getElementById('vBs');
    b.innerHTML=S.sigs.length?S.sigs.map(function(s){return'<div class="v-sig">'+h(s)+'</div>';}).join(''):'<div class="v-emp">Core points extracted here</div>';
    document.getElementById('vCs').textContent=S.sigs.length;b.scrollTop=b.scrollHeight;
  }
  if(w==='ramble'){
    var b=document.getElementById('vBm');
    b.innerHTML=S.rams.length?S.rams.map(function(r){return'<div class="v-ram">'+h(r)+'</div>';}).join(''):'<div class="v-emp">Filler and repetition caught here</div>';
    document.getElementById('vCm').textContent=S.rams.length;b.scrollTop=b.scrollHeight;
  }
  if(w==='action'){
    var b=document.getElementById('vBa');
    b.innerHTML=S.acts.length?S.acts.map(function(a,i){return'<div class="v-act"><span class="v-an">'+String(i+1).padStart(2,'0')+'</span><span>'+h(a)+'</span></div>';}).join(''):'<div class="v-emp">Tasks and commitments land here</div>';
    document.getElementById('vCa').textContent=S.acts.length;b.scrollTop=b.scrollHeight;
  }
  if(w==='clean'){
    var b=document.getElementById('vBc');
    if(S.clean){b.innerHTML='<div class="v-cln">'+h(S.clean)+'</div>';document.getElementById('vCc').textContent=S.clean.split(/\s+/).filter(function(w){return w;}).length+' words';}
    else{b.innerHTML='<div class="v-emp">Compressed output appears here</div>';document.getElementById('vCc').textContent='0';}
  }
}
function upSt(){
  var t=S.raw.split(/\s+/).filter(function(w){return w;}).length;
  document.getElementById('vSw').textContent=t;
  var sw=S.sigs.join(' ').split(/\s+/).filter(function(w){return w;}).length;
  document.getElementById('vSr').textContent=t>0?Math.round(sw/t*100)+'%':'—';
  var el=document.getElementById('vSe'),bar=document.getElementById('vEdge');
  el.textContent=S.edge.toFixed(2);
  if(S.edge>0.3){el.style.color='var(--v-edge)';bar.classList.add('hot');}
  else{el.style.color='';bar.classList.remove('hot');}
}

// --- SPEECH ---
function initSp(){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){document.getElementById('vMic').classList.add('off');S.hasMic=false;return;}
  S.hasMic=true;
  var rec=new SR();rec.continuous=true;rec.interimResults=true;rec.lang='en-US';rec.maxAlternatives=1;
  var ft='';
  rec.onresult=function(e){var im='',nf='';for(var i=e.resultIndex;i<e.results.length;i++){var t=e.results[i][0].transcript;if(e.results[i].isFinal)nf+=t;else im+=t;}if(nf){ft+=nf;S.interim='';appSp(nf);}else{S.interim=im;draw('raw');}};
  rec.onend=function(){if(S.on)try{rec.start();}catch(e){}};
  rec.onerror=function(e){if(e.error==='no-speech'||e.error==='aborted')return;console.warn('Speech error:',e.error);};
  S.rec=rec;
}
function togMic(){
  if(!S.hasMic||!S.rec)return;
  var btn=document.getElementById('vMic');
  if(S.on){S.on=false;S.rec.stop();btn.classList.remove('active');}
  else{S.on=true;try{S.rec.start();}catch(e){}btn.classList.add('active');}
}
function clrAll(){
  S.raw='';S.sents=[];S.sigs=[];S.rams=[];S.acts=[];S.clean='';S.edge=0;S.recent=[];S.interim='';
  ['raw','signal','ramble','action','clean'].forEach(draw);upSt();
  document.getElementById('vTa').value='';
}

// --- INIT ---
document.addEventListener('DOMContentLoaded',function(){
  initSp();
  document.getElementById('vMic').addEventListener('click',togMic);
  document.getElementById('vClr').addEventListener('click',clrAll);
  document.getElementById('vGo').addEventListener('click',function(){var t=document.getElementById('vTa').value.trim();if(t)procAll(t);});
  var ta=document.getElementById('vTa');
  ta.addEventListener('input',function(){this.style.height='38px';this.style.height=Math.min(this.scrollHeight,80)+'px';});
  ta.addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();var t=this.value.trim();if(t)procAll(t);}});
  document.addEventListener('keydown',function(e){if(e.code==='Space'&&e.target===document.body){e.preventDefault();togMic();}});
  // Mobile tabs
  document.querySelectorAll('.v-mt').forEach(function(tab){tab.addEventListener('click',function(){var p=this.dataset.p;document.querySelectorAll('.v-mt').forEach(function(t){t.classList.remove('on');});this.classList.add('on');document.querySelectorAll('.v-pn').forEach(function(el){el.classList.remove('on');});document.querySelector('.v-pn[data-p="'+p+'"]').classList.add('on');});});
  // Export
  document.querySelectorAll('.v-xb').forEach(function(btn){btn.addEventListener('click',function(){var w=this.dataset.c,t='';if(w==='raw')t=S.raw;else if(w==='signal')t=S.sigs.join('\n');else if(w==='action')t=S.acts.map(function(a,i){return(i+1)+'. '+a;}).join('\n');else if(w==='clean')t=S.clean;if(t&&navigator.clipboard){var b=this;navigator.clipboard.writeText(t).then(function(){b.classList.add('ok');b.textContent='COPIED';setTimeout(function(){b.classList.remove('ok');b.textContent='COPY '+w.toUpperCase();},1500);});}});});
});
})();
</script>
{% endblock %}
