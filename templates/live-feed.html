<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NTI Live Feed — Real-Time Structural Analysis | Artifact Zero Labs</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090d;--surface:#0e1117;--surface2:#151921;--surface3:#1a1f2b;
  --border:#1e2433;--border2:#2a3040;
  --text:#e2e5eb;--muted:#5c6370;--dim:#3d4452;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--green-dim:#16a34a;
  --red:#ef4444;--red-dim:#991b1b;
  --amber:#f59e0b;--amber-dim:#92400e;
  --purple:#a78bfa;
  --cyan:#22d3ee;--teal:#2dd4bf;--pink:#f472b6;--orange:#fb923c;
}
*{margin:0;padding:0;box-sizing:border-box}
html{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased}
body{min-height:100vh;overflow-x:hidden}

.topbar{
  position:sticky;top:0;z-index:100;
  background:rgba(7,9,13,.92);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:14px 24px;display:flex;align-items:center;justify-content:space-between;
}
.topbar .logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:13px;letter-spacing:2px;color:var(--accent)}
.topbar .logo a{color:inherit;text-decoration:none}
.topbar-right{display:flex;align-items:center;gap:14px}
.live-badge{
  display:flex;align-items:center;gap:6px;
  font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);
  background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);
  padding:4px 10px;border-radius:4px;
}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.hero{
  text-align:center;padding:40px 24px 20px;
  background:linear-gradient(180deg,rgba(59,130,246,.04) 0%,transparent 100%);
}
.hero h1{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;letter-spacing:1px;margin-bottom:8px}
.hero h1 span{color:var(--accent)}
.hero p{font-size:14px;color:var(--muted);max-width:640px;margin:0 auto;line-height:1.6}
.hero .disclaimer{
  font-size:11px;color:var(--dim);margin-top:12px;
  font-family:'JetBrains Mono',monospace;letter-spacing:.3px;
}

.source-bar{display:flex;gap:6px;padding:16px 24px 8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;align-items:center}
.source-bar::-webkit-scrollbar{display:none}
.cat-sep{width:1px;height:24px;background:var(--border);flex-shrink:0;margin:0 4px}
.source-tab{
  font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;
  padding:10px 20px;border-radius:6px;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--muted);
  transition:all .2s;position:relative;white-space:nowrap;flex-shrink:0;
}
.source-tab:hover{border-color:var(--border2);color:var(--text)}
.source-tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.source-tab .tab-count{font-size:10px;font-weight:400;opacity:.7;margin-left:6px}
.source-tab .tab-pulse{
  position:absolute;top:6px;right:6px;width:5px;height:5px;border-radius:50%;
  background:var(--green);animation:pulse 2s infinite;
}

.feed-controls{
  display:flex;justify-content:space-between;align-items:center;
  max-width:1200px;margin:0 auto;padding:12px 24px;
}
.auto-label{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.feed-stats{display:flex;gap:16px;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.feed-stats span{display:flex;align-items:center;gap:4px}

.feed{max-width:1200px;margin:0 auto;padding:0 24px 60px}

.feed-item{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:14px;overflow:hidden;transition:border-color .2s;
}
.feed-item:hover{border-color:var(--border2)}

.feed-item-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;border-bottom:1px solid var(--border);background:var(--surface2);
}
.feed-source{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--cyan)}
.feed-time{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}

.feed-columns{display:grid;grid-template-columns:1fr 1fr;min-height:0}
.feed-col{padding:16px;position:relative}
.feed-col:first-child{border-right:1px solid var(--border)}
.feed-col-label{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;
  display:flex;align-items:center;gap:6px;
}
.label-original{color:var(--muted)}
.label-nti{color:var(--accent)}

.feed-headline{font-size:16px;font-weight:600;line-height:1.4;margin-bottom:8px}
.feed-summary{font-size:13px;color:var(--muted);line-height:1.6}
.feed-link{font-size:11px;color:var(--accent2);text-decoration:none;margin-top:8px;display:inline-block}
.feed-link:hover{text-decoration:underline}

/* NTI chips */
.nti-score-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.nti-chip{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px}
.chip-good{background:#14532d;color:#86efac}
.chip-warn{background:#78350f;color:#fde68a}
.chip-bad{background:#7f1d1d;color:#fca5a5}
.chip-info{background:rgba(59,130,246,.15);color:var(--accent2)}

.nti-findings{font-size:13px;color:var(--text);line-height:1.6}
.nti-finding-label{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--purple);margin-top:8px;margin-bottom:3px}
.nti-tilt-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.nti-tilt-tag{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;padding:2px 7px;border-radius:3px;background:var(--surface3);color:var(--amber)}

.nti-spinner{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;padding:20px 0}
.nti-spinner .spin{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── ANALYSIS GAUGES ── */
.axis-section{margin-top:12px;border-top:1px solid var(--border);padding-top:10px}
.axis-section-title{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;color:var(--cyan);margin-bottom:8px;
}
.axis-row{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.axis-label{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;
  color:var(--muted);width:100px;flex-shrink:0;text-transform:uppercase;letter-spacing:.3px;
}
.axis-bar-track{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;position:relative}
.axis-bar-fill{height:100%;border-radius:3px;transition:width .4s ease}
.axis-value{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;
  width:42px;text-align:right;flex-shrink:0;
}
.axis-detail{font-size:11px;color:var(--dim);margin-top:2px;margin-bottom:6px;padding-left:108px}

/* Color classes for axes */
.bar-green .axis-bar-fill{background:var(--green)}
.bar-amber .axis-bar-fill{background:var(--amber)}
.bar-red .axis-bar-fill{background:var(--red)}
.bar-blue .axis-bar-fill{background:var(--accent)}
.bar-cyan .axis-bar-fill{background:var(--cyan)}
.bar-teal .axis-bar-fill{background:var(--teal)}
.bar-pink .axis-bar-fill{background:var(--pink)}
.bar-purple .axis-bar-fill{background:var(--purple)}
.bar-orange .axis-bar-fill{background:var(--orange)}

.val-green{color:var(--green)}.val-amber{color:var(--amber)}.val-red{color:var(--red)}
.val-blue{color:var(--accent)}.val-cyan{color:var(--cyan)}.val-teal{color:var(--teal)}
.val-pink{color:var(--pink)}.val-purple{color:var(--purple)}.val-orange{color:var(--orange)}

/* Skeleton */
.skeleton-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:14px;overflow:hidden}
.skeleton-header{height:40px;background:var(--surface2);border-bottom:1px solid var(--border)}
.skeleton-body{display:grid;grid-template-columns:1fr 1fr;min-height:120px}
.skeleton-col{padding:16px}
.skeleton-col:first-child{border-right:1px solid var(--border)}
.skeleton-line{height:12px;background:var(--surface2);border-radius:4px;margin-bottom:8px;animation:shimmer 1.5s infinite}
.skeleton-line.w80{width:80%}.skeleton-line.w60{width:60%}.skeleton-line.w90{width:90%}.skeleton-line.w40{width:40%}
@keyframes shimmer{0%{opacity:.4}50%{opacity:.7}100%{opacity:.4}}

.empty-state{text-align:center;padding:60px 20px;font-size:14px;color:var(--muted)}
.empty-state .icon{font-size:40px;margin-bottom:12px;opacity:.3}

@media(max-width:768px){
  .feed-columns{grid-template-columns:1fr;gap:0}
  .feed-col:first-child{border-right:none;border-bottom:1px solid var(--border)}
  .hero h1{font-size:18px}
  .source-tab{padding:8px 14px;font-size:11px}
  .axis-label{width:80px;font-size:9px}
  .axis-detail{padding-left:88px}
}

/* Article Reader Overlay */
.article-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:1000;
  background:rgba(0,0,0,.85);backdrop-filter:blur(8px);
  display:none;overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.article-overlay.open{display:block}
.article-reader{
  max-width:800px;margin:40px auto;padding:32px;
  background:var(--bg);border:1px solid var(--border);border-radius:12px;
  position:relative;
}
.article-reader-close{
  position:absolute;top:16px;right:16px;background:var(--surface);border:1px solid var(--border);
  color:var(--text);width:32px;height:32px;border-radius:6px;font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
.article-reader-close:hover{border-color:var(--accent);color:var(--accent)}
.article-reader-source{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.article-reader-title{font-size:24px;font-weight:700;color:var(--text);line-height:1.3;margin-bottom:12px}
.article-reader-meta{font-size:12px;color:var(--muted);margin-bottom:24px;display:flex;gap:16px;align-items:center}
.article-reader-body{font-size:15px;line-height:1.8;color:var(--dim);margin-bottom:32px}
.article-reader-body p{margin-bottom:16px}
.article-reader-nti{padding-top:24px;border-top:1px solid var(--border)}
.article-reader-ext{margin-top:16px;text-align:center}
.article-reader-ext a{
  display:inline-block;padding:10px 24px;background:var(--surface);border:1px solid var(--border);
  color:var(--accent);text-decoration:none;border-radius:6px;font-size:13px;font-weight:600;
  transition:all .2s;
}
.article-reader-ext a:hover{border-color:var(--accent);background:var(--accent);color:#fff}
@media(max-width:768px){
  .article-reader{margin:16px;padding:20px}
  .article-reader-title{font-size:20px}
}

.footer{
  text-align:center;padding:24px;font-size:11px;color:var(--dim);
  border-top:1px solid var(--border);margin-top:20px;font-family:'JetBrains Mono',monospace;
}
.footer a{color:var(--accent);text-decoration:none}
</style>
</head>
<body>

<!-- old topbar removed — az-shell.js provides unified header -->

<div class="hero" style="padding-top:70px">
  <h1>NTI <span>LIVE FEED</span></h1>
  <p>Real-time news from national and local outlets, run through the NTI structural analysis engine. Same information, shown two ways — side by side.</p>
  <div class="disclaimer">We don't say correct. We say different. You decide.</div>
</div>

<div class="source-bar" id="sourceTabs"></div>

<div class="feed-controls">
  <div class="auto-label">Auto-refreshes every 120s</div>
  <div class="feed-stats">
    <span>Items analyzed: <strong id="statCount">0</strong></span>
    <span>Avg NII: <strong id="statNII">—</strong></span>
    <span>Last update: <strong id="statTime">—</strong></span>
  </div>
</div>

<div class="feed" id="feed">
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w80"></div><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div></div><div class="skeleton-col"><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div></div></div></div>
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div></div><div class="skeleton-col"><div class="skeleton-line w40"></div><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div></div></div></div>
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div><div class="skeleton-line w90"></div></div><div class="skeleton-col"><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div><div class="skeleton-line w60"></div></div></div></div>
</div>

<div class="footer">
  Artifact Zero Labs · NTI Live Feed · Rule-based structural analysis, zero LLM dependency · <a href="/">Main Dashboard</a> · <a href="/health">Health</a>
</div>

<!-- Article Reader Overlay -->
<div class="article-overlay" id="articleOverlay">
  <div class="article-reader" id="articleReader">
    <button class="article-reader-close" onclick="closeArticle()">&times;</button>
    <div id="articleContent">Loading...</div>
  </div>
</div>

<script>
// ══════════════════════════════════════
// CONFIG
// ══════════════════════════════════════
const SOURCES = [
  // NEWS
  { id: 'bbc',      name: 'BBC WORLD',      rss: 'https://feeds.bbci.co.uk/news/world/rss.xml',       cat: 'news' },
  { id: 'npr',      name: 'NPR NEWS',       rss: 'https://feeds.npr.org/1001/rss.xml',                cat: 'news' },
  { id: 'nbc',      name: 'NBC NEWS',       rss: 'https://feeds.nbcnews.com/nbcnews/public/news',     cat: 'news' },
  // SPORTS
  { id: 'espn',     name: 'ESPN',           rss: 'https://www.espn.com/espn/rss/news',                 cat: 'sports' },
  { id: 'cbs',      name: 'CBS SPORTS',     rss: 'https://www.cbssports.com/rss/headlines',            cat: 'sports' },
  { id: 'bbcsport', name: 'BBC SPORT',      rss: 'https://feeds.bbci.co.uk/sport/rss.xml',            cat: 'sports' },
  // TECH
  { id: 'ars',      name: 'ARS TECHNICA',   rss: 'https://feeds.arstechnica.com/arstechnica/technology-lab', cat: 'tech' },
  { id: 'tc',       name: 'TECHCRUNCH',     rss: 'https://techcrunch.com/feed',                        cat: 'tech' },
  // BUSINESS
  { id: 'cnbc',     name: 'CNBC',           rss: 'https://search.cnbc.com/rs/search/combinedcms/view.xml?partnerId=wrss01&id=100003114', cat: 'biz' },
  // LOCAL — KNOXVILLE
  { id: 'wate',     name: 'WATE 6',         rss: 'https://wate.com/feed/',                               cat: 'local' },
  { id: 'wbir',     name: 'WBIR 10',        rss: 'https://rssfeeds.wbir.com/wbir/local',                 cat: 'local' },
  { id: 'wvlt',     name: 'WVLT 8',         rss: 'https://www.wvlt.tv/feed/',                            cat: 'local' },
  { id: 'knoxfocus', name: 'KNOX FOCUS',    rss: 'https://feeds.feedburner.com/KnoxFocus',               cat: 'local' },
];

const REFRESH_INTERVAL = 120000;
const MAX_ITEMS = 15;

let activeSource = SOURCES[0].id;
let feedCache = {};
let refreshTimer = null;
let totalAnalyzed = 0;
let niiSum = 0;

// ══════════════════════════════════════
// ANALYSIS AXIS 1: READABILITY (Flesch-Kincaid)
// ══════════════════════════════════════
function countSyllables(word) {
  word = word.toLowerCase().replace(/[^a-z]/g, '');
  if (word.length <= 2) return 1;
  word = word.replace(/(?:[^laeiouy]es|ed|[^laeiouy]e)$/, '');
  word = word.replace(/^y/, '');
  const m = word.match(/[aeiouy]{1,2}/g);
  return m ? m.length : 1;
}

function analyzeReadability(text) {
  if (!text || text.length < 10) return { grade: 0, label: 'N/A', detail: '' };
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
  const words = text.split(/\s+/).filter(w => w.length > 0);
  const sentCount = Math.max(sentences.length, 1);
  const wordCount = Math.max(words.length, 1);
  const syllCount = words.reduce((sum, w) => sum + countSyllables(w), 0);

  // Flesch-Kincaid Grade Level
  const grade = Math.max(0, Math.min(18,
    0.39 * (wordCount / sentCount) + 11.8 * (syllCount / wordCount) - 15.59
  ));
  const rounded = Math.round(grade * 10) / 10;

  let label, detail;
  if (rounded <= 6) { label = 'Elementary'; detail = 'Very easy to read'; }
  else if (rounded <= 8) { label = 'Middle School'; detail = 'Accessible to general audience'; }
  else if (rounded <= 10) { label = 'High School'; detail = 'Moderate complexity'; }
  else if (rounded <= 13) { label = 'College'; detail = 'Requires higher education'; }
  else { label = 'Graduate'; detail = 'Academic-level complexity'; }

  return { grade: rounded, label, detail, sentCount, wordCount, syllCount };
}

// ══════════════════════════════════════
// ANALYSIS AXIS 2: EMOTIONAL CHARGE
// ══════════════════════════════════════
const EMOTIONAL_WORDS = {
  high: ['slammed','devastating','outrage','fury','shocking','horrifying','terrifying','explosive',
    'catastrophic','nightmare','brutal','crushed','destroyed','chaos','panic','crisis','tragic',
    'heartbreaking','alarming','dire','desperate','rage','furious','slamming','blasted','ripped',
    'gutted','bombshell','firestorm','backlash','meltdown','uproar','revolt','erupted','plunged',
    'collapsed','shattered','rocked','stunned','reeling','bloodbath','massacre','carnage','lethal'],
  moderate: ['concerns','tensions','controversial','disputed','criticized','warned','urged','demanded',
    'clashed','accused','rejected','condemned','fears','threatened','escalated','sparked','triggered',
    'struggling','embattled','contentious','divisive','heated','intensified','pressured','volatile',
    'strained','faltering','turbulent','fraught','grim','stark','severe','mounting','surging'],
  neutral: ['said','reported','announced','stated','according','noted','indicated','confirmed',
    'released','published','scheduled','proposed','discussed','examined','analyzed','reviewed',
    'considered','observed','maintained','explained','described','outlined','addressed','presented']
};

function analyzeEmotionalCharge(text) {
  if (!text || text.length < 10) return { score: 0, label: 'N/A', words: [] };
  const lower = text.toLowerCase();
  const words = lower.split(/\s+/);
  const total = Math.max(words.length, 1);

  let highHits = [];
  let modHits = [];
  let neutralCount = 0;

  EMOTIONAL_WORDS.high.forEach(w => { if (lower.includes(w)) highHits.push(w); });
  EMOTIONAL_WORDS.moderate.forEach(w => { if (lower.includes(w)) modHits.push(w); });
  EMOTIONAL_WORDS.neutral.forEach(w => { if (lower.includes(w)) neutralCount++; });

  const rawScore = (highHits.length * 3 + modHits.length * 1.5) / total * 100;
  const score = Math.min(100, Math.round(rawScore * 8));

  let label;
  if (score <= 15) label = 'Clinical';
  else if (score <= 35) label = 'Neutral';
  else if (score <= 60) label = 'Moderate';
  else if (score <= 80) label = 'Charged';
  else label = 'Highly Charged';

  return { score, label, highWords: highHits, modWords: modHits, neutralCount };
}

// ══════════════════════════════════════
// ANALYSIS AXIS 3: ASSERTION DENSITY
// ══════════════════════════════════════
const ATTRIBUTION_MARKERS = [
  'according to','said','told','reported by','citing','sources say','officials say',
  'spokesperson','statement from','confirmed by','per ','as reported','witnesses said',
  'in a statement','the report said','data shows','studies show','research indicates',
  'analysts say','experts say','a spokesperson for','the department said','officials said',
  'the company said','the government said','authorities said','police said','the court said'
];

function analyzeAssertionDensity(text) {
  if (!text || text.length < 10) return { score: 0, label: 'N/A' };
  const lower = text.toLowerCase();
  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 2);
  const sentCount = Math.max(sentences.length, 1);

  let attributed = 0;
  sentences.forEach(sent => {
    const sl = sent.toLowerCase();
    if (ATTRIBUTION_MARKERS.some(m => sl.includes(m))) attributed++;
  });

  const unattributed = sentCount - attributed;
  const ratio = Math.round((unattributed / sentCount) * 100);

  let label;
  if (ratio <= 30) label = 'Well-Attributed';
  else if (ratio <= 50) label = 'Mostly Attributed';
  else if (ratio <= 70) label = 'Mixed';
  else if (ratio <= 85) label = 'Mostly Unattributed';
  else label = 'Assertion-Heavy';

  return { score: ratio, label, attributed, unattributed, sentCount };
}

// ══════════════════════════════════════
// ANALYSIS AXIS 4: INFORMATION DENSITY
// ══════════════════════════════════════
const NUMBER_RE = /\b\d[\d,.]*\b/g;
const DATE_RE = /\b(?:jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|january|february|march|april|june|july|august|september|october|november|december|\d{4}|monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/gi;
const PROPER_NOUN_RE = /\b[A-Z][a-z]{2,}\b/g;
const PERCENT_RE = /\d+\s*%/g;
const MONEY_RE = /[\$£€]\s*[\d,.]+|\d+\s*(?:billion|million|trillion|thousand)/gi;

function analyzeInfoDensity(text) {
  if (!text || text.length < 10) return { score: 0, label: 'N/A' };
  const words = text.split(/\s+/).filter(w => w.length > 0);
  const total = Math.max(words.length, 1);

  const numbers = (text.match(NUMBER_RE) || []).length;
  const dates = (text.match(DATE_RE) || []).length;
  const names = (text.match(PROPER_NOUN_RE) || []).length;
  const percents = (text.match(PERCENT_RE) || []).length;
  const money = (text.match(MONEY_RE) || []).length;

  const factualElements = numbers + dates + names + percents + money;
  const ratio = factualElements / total;
  const score = Math.min(100, Math.round(ratio * 250));

  let label;
  if (score >= 70) label = 'Very Dense';
  else if (score >= 50) label = 'Dense';
  else if (score >= 30) label = 'Moderate';
  else if (score >= 15) label = 'Light';
  else label = 'Sparse';

  return { score, label, numbers, dates, names, percents, money, factualElements };
}

// ══════════════════════════════════════
// ANALYSIS AXIS 5: SOURCE ATTRIBUTION
// ══════════════════════════════════════
const NAMED_SOURCE_RE = /(?:said|told|according to|confirmed by|spokesperson for|statement from)\s+[A-Z][a-z]+/g;
const ANON_SOURCE_MARKERS = [
  'sources say','sources said','anonymous source','unnamed source','officials say',
  'officials said','people familiar','person familiar','those close to','insiders say',
  'a source close','sources familiar','according to sources','people briefed',
  'those with knowledge','a person with'
];
const DIRECT_QUOTE_RE = /[""][^""]{10,}[""]|["][^"]{10,}["]/g;

function analyzeSourceAttribution(text) {
  if (!text || text.length < 10) return { score: 0, label: 'N/A' };
  const lower = text.toLowerCase();

  const namedSources = (text.match(NAMED_SOURCE_RE) || []).length;
  const anonSources = ANON_SOURCE_MARKERS.filter(m => lower.includes(m)).length;
  const directQuotes = (text.match(DIRECT_QUOTE_RE) || []).length;

  const totalSources = namedSources + anonSources;
  const namedRatio = totalSources > 0 ? Math.round((namedSources / totalSources) * 100) : 0;

  // Score: higher = more named attribution (better)
  const score = Math.min(100, namedSources * 25 + directQuotes * 15 - anonSources * 10);
  const finalScore = Math.max(0, score);

  let label;
  if (totalSources === 0 && directQuotes === 0) label = 'No Sources Cited';
  else if (namedRatio >= 75) label = 'Named Sources';
  else if (namedRatio >= 50) label = 'Mixed Sources';
  else if (anonSources > 0) label = 'Anonymous Sources';
  else label = 'Unattributed';

  return { score: finalScore, label, namedSources, anonSources, directQuotes };
}

// ══════════════════════════════════════
// COMBINED CLIENT-SIDE ANALYSIS
// ══════════════════════════════════════
function runClientAnalysis(text) {
  return {
    readability: analyzeReadability(text),
    emotional: analyzeEmotionalCharge(text),
    assertion: analyzeAssertionDensity(text),
    infoDensity: analyzeInfoDensity(text),
    sourceAttr: analyzeSourceAttribution(text)
  };
}

// ══════════════════════════════════════
// FEED LOGIC
// ══════════════════════════════════════
function init() {
  renderTabs();
  SOURCES.forEach(s => { feedCache[s.id] = []; });
  fetchAllSources();
  refreshTimer = setInterval(fetchAllSources, REFRESH_INTERVAL);
}

function renderTabs() {
  const bar = document.getElementById('sourceTabs');
  let lastCat = '';
  bar.innerHTML = SOURCES.map(s => {
    let sep = '';
    if (lastCat && s.cat !== lastCat) sep = '<div class="cat-sep"></div>';
    lastCat = s.cat;
    const count = (feedCache[s.id] || []).length;
    return `${sep}<div class="source-tab ${s.id === activeSource ? 'active' : ''}" onclick="switchSource('${s.id}')">
      ${s.name}
      <span class="tab-count" id="count-${s.id}">(${count})</span>
      <span class="tab-pulse"></span>
    </div>`;
  }).join('');
}

function switchSource(id) {
  activeSource = id;
  renderTabs();
  renderFeed();
}

async function fetchAllSources() {
  for (const source of SOURCES) {
    try { await fetchSource(source); } catch (e) { console.error(`Failed: ${source.name}`, e); }
  }
  updateStats();
}

async function fetchSource(source) {
  try {
    const res = await fetch('/api/rss-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: source.rss, max_items: MAX_ITEMS })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data.items || !data.items.length) return;

    const existing = new Map(feedCache[source.id].map(i => [i.title, i]));
    const newItems = data.items.filter(i => !existing.has(i.title));

    for (const item of newItems) {
      const fullText = `${item.title}. ${item.summary || item.description || ''}`;
      const entry = {
        title: item.title || '',
        summary: item.summary || item.description || '',
        link: item.link || '',
        pubDate: item.pubDate || '',
        source: source.name,
        sourceId: source.id,
        ntiResult: null,
        ntiLoading: true,
        clientAnalysis: runClientAnalysis(fullText)
      };
      feedCache[source.id].push(entry);
      sortFeed(source.id);
      if (source.id === activeSource) renderFeed();

      try {
        const ntiRes = await fetch('/nti', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: fullText })
        });
        const ntiData = await ntiRes.json();
        entry.ntiResult = ntiData;
        entry.ntiLoading = false;
        totalAnalyzed++;
        if (ntiData.nii?.nii_score != null) niiSum += ntiData.nii.nii_score;
      } catch (e) {
        entry.ntiLoading = false;
        entry.ntiError = true;
      }
      if (source.id === activeSource) renderFeed();
    }

    if (feedCache[source.id].length > MAX_ITEMS) {
      feedCache[source.id] = feedCache[source.id].slice(0, MAX_ITEMS);
    }
    const countEl = document.getElementById(`count-${source.id}`);
    if (countEl) countEl.textContent = `(${feedCache[source.id].length})`;
  } catch (e) {
    console.error(`RSS fetch error for ${source.name}:`, e);
  }
}

function sortFeed(sourceId) {
  feedCache[sourceId].sort((a, b) => {
    const da = a.pubDate ? new Date(a.pubDate).getTime() : 0;
    const db = b.pubDate ? new Date(b.pubDate).getTime() : 0;
    return db - da; // newest first
  });
}

// ══════════════════════════════════════
// RENDER
// ══════════════════════════════════════
function renderFeed() {
  const feed = document.getElementById('feed');
  const items = feedCache[activeSource] || [];
  if (!items.length) {
    feed.innerHTML = `<div class="empty-state"><div class="icon">◎</div>Loading feed from ${SOURCES.find(s=>s.id===activeSource)?.name}...</div>`;
    return;
  }
  feed.innerHTML = items.map(item => renderItem(item)).join('');
}

function renderItem(item) {
  const timeStr = item.pubDate ? formatTime(item.pubDate) : '';

  let ntiCol;
  if (item.ntiLoading) {
    ntiCol = `<div class="nti-spinner"><div class="spin"></div>Running NTI analysis...</div>`;
  } else if (item.ntiError) {
    ntiCol = `<div style="color:var(--dim);font-size:12px">Analysis unavailable</div>`;
  } else {
    ntiCol = renderNTI(item.ntiResult, item.clientAnalysis);
  }

  const itemIdx = feedCache[item.sourceId]?.indexOf(item) ?? -1;

  return `
    <div class="feed-item">
      <div class="feed-item-header">
        <div class="feed-source">${item.source}</div>
        <div class="feed-time">${timeStr}</div>
      </div>
      <div class="feed-columns">
        <div class="feed-col">
          <div class="feed-col-label label-original">● ORIGINAL</div>
          <div class="feed-headline" style="cursor:pointer" onclick="openArticle('${item.sourceId}',${itemIdx})">${escHtml(item.title)}</div>
          <div class="feed-summary">${escHtml(item.summary)}</div>
          <a class="feed-link" href="#" onclick="event.preventDefault();openArticle('${item.sourceId}',${itemIdx})">Read full article →</a>
        </div>
        <div class="feed-col">
          <div class="feed-col-label label-nti">◆ NTI STRUCTURAL ANALYSIS</div>
          ${ntiCol}
        </div>
      </div>
    </div>
  `;
}

function renderNTI(data, ca) {
  if (!data || data.error) return '<div style="color:var(--dim);font-size:12px">No data</div>';

  const nii = data.nii || {};
  const fm = data.parent_failure_modes || {};
  const tilt = data.tilt_taxonomy || [];
  const score = nii.nii_score ?? 0;
  const scoreClass = score >= 0.8 ? 'chip-good' : score >= 0.5 ? 'chip-warn' : 'chip-bad';
  const scoreLabel = score >= 0.8 ? 'HIGH INTEGRITY' : score >= 0.5 ? 'MODERATE' : 'LOW INTEGRITY';

  const modes = ['UDDS', 'DCE', 'CCA'];
  const activeFailures = modes.filter(m => {
    const state = fm[m]?.[`${m.toLowerCase()}_state`] || '';
    return state && !state.includes('FALSE');
  });

  let html = `<div class="nti-score-row">`;
  html += `<span class="nti-chip ${scoreClass}">NII: ${(score * 100).toFixed(0)}% — ${scoreLabel}</span>`;
  if (activeFailures.length) {
    html += `<span class="nti-chip chip-bad">${activeFailures.join(' + ')} DETECTED</span>`;
  } else {
    html += `<span class="nti-chip chip-good">NO FAILURE MODES</span>`;
  }
  html += `</div>`;

  html += `<div class="nti-findings">`;

  // Constraints
  const constraints = data.layers?.L0_reality_substrate?.constraints_found || [];
  if (constraints.length) {
    html += `<div class="nti-finding-label">CONSTRAINTS DETECTED</div>`;
    html += `<div style="font-size:12px;color:var(--muted)">${constraints.map(c => `<code style="background:var(--surface3);padding:1px 5px;border-radius:3px;font-size:11px">${escHtml(c)}</code>`).join(' ')}</div>`;
  }

  // Framing
  const framing = data.layers?.L2_interpretive_framing || {};
  const framingItems = [...(framing.hedge_markers||[]), ...(framing.reassurance_markers||[]), ...(framing.category_blend_markers||[])];
  if (framingItems.length) {
    html += `<div class="nti-finding-label">FRAMING MARKERS</div>`;
    html += `<div style="font-size:12px;color:var(--muted)">${framingItems.map(f => `"${escHtml(f)}"`).join(', ')}</div>`;
  }

  // Tilt
  if (tilt.length) {
    html += `<div class="nti-finding-label">TILT CATEGORIES</div>`;
    html += `<div class="nti-tilt-tags">${tilt.map(t => `<span class="nti-tilt-tag">${t}</span>`).join('')}</div>`;
  }

  // Failure mode detail
  if (activeFailures.length) {
    html += `<div class="nti-finding-label">FAILURE MODES</div>`;
    activeFailures.forEach(m => {
      const labels = { UDDS: 'Upstream Denial via Downstream Substitution', DCE: 'Deferred Constraint Externalization', CCA: 'Constraint Collapse via Aggregation' };
      const st = fm[m]?.[`${m.toLowerCase()}_state`] || '';
      const severity = st.includes('CONFIRMED') ? 'CONFIRMED' : 'PROBABLE';
      html += `<div style="font-size:12px;color:var(--red);margin-top:2px">● ${m}: ${labels[m]} (${severity})</div>`;
    });
  }

  if (!constraints.length && !framingItems.length && !tilt.length && !activeFailures.length) {
    html += `<div style="color:var(--green);font-size:13px;margin-top:4px">✓ Clean structural profile — no drift, framing, or failure modes detected.</div>`;
  }

  html += `</div>`;

  // ── EXTENDED ANALYSIS AXES ──
  if (ca) {
    html += `<div class="axis-section">`;
    html += `<div class="axis-section-title">Extended Structural Analysis</div>`;

    // 1. Readability
    const r = ca.readability;
    const rPct = Math.min(100, Math.round((r.grade / 16) * 100));
    const rColor = r.grade <= 8 ? 'green' : r.grade <= 12 ? 'amber' : 'red';
    html += renderGauge('Reading', `${r.grade}`, rPct, rColor, `${r.label} — Grade ${r.grade}`);

    // 2. Emotional Charge
    const e = ca.emotional;
    const eColor = e.score <= 25 ? 'cyan' : e.score <= 50 ? 'amber' : 'pink';
    html += renderGauge('Emotion', `${e.score}%`, e.score, eColor, `${e.label}${e.highWords.length ? ' — "' + e.highWords.slice(0,3).join('", "') + '"' : ''}`);

    // 3. Assertion Density
    const a = ca.assertion;
    const aColor = a.score <= 40 ? 'green' : a.score <= 65 ? 'amber' : 'red';
    html += renderGauge('Assertions', `${a.score}%`, a.score, aColor, `${a.label} — ${a.attributed}/${a.sentCount} attributed`);

    // 4. Info Density
    const id = ca.infoDensity;
    const idColor = id.score >= 50 ? 'teal' : id.score >= 25 ? 'blue' : 'orange';
    html += renderGauge('Info Dense', `${id.score}%`, id.score, idColor, `${id.label} — ${id.factualElements} facts in ${id.score > 0 ? Math.round(id.factualElements / (id.score/100) * 4) : '?'} words`);

    // 5. Source Attribution
    const sa = ca.sourceAttr;
    const saColor = sa.score >= 60 ? 'green' : sa.score >= 30 ? 'purple' : 'red';
    html += renderGauge('Sources', `${sa.score}%`, sa.score, saColor, `${sa.label}${sa.namedSources ? ' — ' + sa.namedSources + ' named' : ''}${sa.anonSources ? ', ' + sa.anonSources + ' anon' : ''}`);

    html += `</div>`;
  }

  return html;
}

function renderGauge(label, value, pct, color, detail) {
  return `
    <div class="axis-row bar-${color}">
      <div class="axis-label">${label}</div>
      <div class="axis-bar-track"><div class="axis-bar-fill" style="width:${Math.max(2, pct)}%"></div></div>
      <div class="axis-value val-${color}">${value}</div>
    </div>
    ${detail ? `<div class="axis-detail">${escHtml(detail)}</div>` : ''}
  `;
}

// ══════════════════════════════════════
// UTILS
// ══════════════════════════════════════
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function formatTime(dateStr) {
  try {
    const d = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - d) / 60000);
    if (diff < 1) return 'Just now';
    if (diff < 60) return `${diff}m ago`;
    if (diff < 1440) return `${Math.floor(diff / 60)}h ago`;
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch { return dateStr; }
}

function updateStats() {
  document.getElementById('statCount').textContent = totalAnalyzed;
  document.getElementById('statNII').textContent = totalAnalyzed > 0 ? (niiSum / totalAnalyzed * 100).toFixed(0) + '%' : '—';
  document.getElementById('statTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// ══════════════════════════════════════
// ARTICLE READER
// ══════════════════════════════════════
function openArticle(sourceId, idx) {
  const item = feedCache[sourceId]?.[idx];
  if (!item) return;

  const overlay = document.getElementById('articleOverlay');
  const content = document.getElementById('articleContent');
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';

  // Build NTI section if available
  let ntiSection = '';
  if (item.ntiResult && !item.ntiError) {
    ntiSection = `<div class="article-reader-nti">${renderNTI(item.ntiResult, item.clientAnalysis)}</div>`;
  }

  // Show immediately with RSS content, then try to fetch full text
  content.innerHTML = `
    <div class="article-reader-source">${item.source}</div>
    <div class="article-reader-title">${escHtml(item.title)}</div>
    <div class="article-reader-meta">
      <span>${item.pubDate ? formatTime(item.pubDate) : ''}</span>
    </div>
    <div class="article-reader-body" id="articleBody">
      <p>${escHtml(item.summary)}</p>
      <div style="color:var(--muted);font-size:13px;padding:16px 0;text-align:center" id="articleLoading">
        Loading full article...
      </div>
    </div>
    ${ntiSection}
    <div class="article-reader-ext">
      ${item.link ? `<a href="${escHtml(item.link)}" target="_blank" rel="noopener">View original on ${item.source} →</a>` : ''}
    </div>
  `;

  // Try fetching full text via proxy
  if (item.link) {
    fetchFullArticle(item.link, item);
  } else {
    document.getElementById('articleLoading').remove();
  }

  overlay.scrollTop = 0;
}

async function fetchFullArticle(url, item) {
  try {
    const res = await fetch('/api/rss-proxy/article', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: url })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    const bodyEl = document.getElementById('articleBody');
    const loadEl = document.getElementById('articleLoading');
    if (loadEl) loadEl.remove();

    if (data.content && data.content.trim()) {
      // Run NTI on full text
      const fullAnalysis = runClientAnalysis(data.content);
      const paragraphs = data.content.split(/\n\n+/).filter(p => p.trim());
      bodyEl.innerHTML = paragraphs.map(p => `<p>${escHtml(p.trim())}</p>`).join('');

      // Add full-text analysis below
      const extDiv = document.createElement('div');
      extDiv.style.cssText = 'margin-top:24px;padding-top:20px;border-top:1px solid var(--border)';
      extDiv.innerHTML = `
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px">
          FULL-TEXT STRUCTURAL ANALYSIS
        </div>
        ${renderExtendedAnalysis(fullAnalysis)}
      `;
      bodyEl.after(extDiv);
    } else {
      if (loadEl) loadEl.textContent = '';
    }
  } catch (e) {
    const loadEl = document.getElementById('articleLoading');
    if (loadEl) loadEl.textContent = '';
  }
}

function closeArticle() {
  document.getElementById('articleOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

// Close on escape key
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeArticle();
});

// Close on overlay background click
document.getElementById('articleOverlay')?.addEventListener('click', e => {
  if (e.target.id === 'articleOverlay') closeArticle();
});

function renderExtendedAnalysis(ca) {
  if (!ca) return '';
  const { readability: r, emotional: em, assertion: a, infoDensity: id, sourceAttr: sa } = ca;
  return `
    <div style="display:grid;gap:12px;margin-top:8px">
      ${r ? `<div><div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:4px"><span style="color:var(--muted)">READING</span><span style="color:${r.grade<=8?'var(--green)':r.grade<=12?'var(--amber)':'var(--red)'}">${r.grade.toFixed(1)}</span></div><div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.min(r.grade/20*100,100)}%;background:${r.grade<=8?'var(--green)':r.grade<=12?'var(--amber)':'var(--red)'};border-radius:3px"></div></div><div style="font-size:11px;color:var(--muted);margin-top:2px">${r.label} — Grade ${r.grade.toFixed(1)}</div></div>` : ''}
      ${em ? `<div><div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:4px"><span style="color:var(--muted)">EMOTION</span><span style="color:${em.score<15?'var(--cyan)':em.score<40?'var(--amber)':'var(--pink,#ec4899)'}">${em.score}%</span></div><div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${em.score}%;background:${em.score<15?'var(--cyan)':em.score<40?'var(--amber)':'#ec4899'};border-radius:3px"></div></div><div style="font-size:11px;color:var(--muted);margin-top:2px">${em.label}</div></div>` : ''}
      ${a ? `<div><div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:4px"><span style="color:var(--muted)">ASSERTIONS</span><span style="color:${a.score<30?'var(--green)':a.score<70?'var(--amber)':'var(--red)'}">${a.score}%</span></div><div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${a.score}%;background:${a.score<30?'var(--green)':a.score<70?'var(--amber)':'var(--red)'};border-radius:3px"></div></div><div style="font-size:11px;color:var(--muted);margin-top:2px">${a.label} — ${a.attributed}/${a.total} attributed</div></div>` : ''}
      ${id ? `<div><div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:4px"><span style="color:var(--muted)">INFO DENSE</span><span style="color:${id.score>60?'teal':id.score>30?'var(--accent)':'var(--amber)'}">${id.score}%</span></div><div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${id.score}%;background:${id.score>60?'teal':id.score>30?'var(--accent)':'var(--amber)'};border-radius:3px"></div></div><div style="font-size:11px;color:var(--muted);margin-top:2px">${id.label} — ${id.factCount} facts in ${id.wordCount} words</div></div>` : ''}
      ${sa ? `<div><div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:11px;margin-bottom:4px"><span style="color:var(--muted)">SOURCES</span><span style="color:${sa.score>60?'var(--green)':sa.score>30?'var(--purple,#9966ff)':'var(--red)'}">${sa.score}%</span></div><div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden"><div style="height:100%;width:${Math.max(sa.score,3)}%;background:${sa.score>60?'var(--green)':sa.score>30?'#9966ff':'var(--red)'};border-radius:3px"></div></div><div style="font-size:11px;color:var(--muted);margin-top:2px">${sa.namedSources} named, ${sa.anonSources} anonymous</div></div>` : ''}
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', init);
</script>
<script src="/static/az-nav.js"></script>

<script src="/static/az-shell.js"></script>
</body>
</html>
