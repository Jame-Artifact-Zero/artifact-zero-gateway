<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NTI Live Feed — Real-Time Structural Analysis | Artifact Zero Labs</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090d;--surface:#0e1117;--surface2:#151921;--surface3:#1a1f2b;
  --border:#1e2433;--border2:#2a3040;
  --text:#e2e5eb;--muted:#5c6370;--dim:#3d4452;
  --accent:#3b82f6;--accent2:#60a5fa;
  --green:#22c55e;--green-dim:#16a34a;
  --red:#ef4444;--red-dim:#991b1b;
  --amber:#f59e0b;--amber-dim:#92400e;
  --purple:#a78bfa;
  --cyan:#22d3ee;
}
*{margin:0;padding:0;box-sizing:border-box}
html{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased}
body{min-height:100vh;overflow-x:hidden}

/* ── TOPBAR ── */
.topbar{
  position:sticky;top:0;z-index:100;
  background:rgba(7,9,13,.92);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  padding:14px 24px;display:flex;align-items:center;justify-content:space-between;
}
.topbar .logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:13px;letter-spacing:2px;color:var(--accent)}
.topbar .logo a{color:inherit;text-decoration:none}
.topbar-right{display:flex;align-items:center;gap:14px}
.live-badge{
  display:flex;align-items:center;gap:6px;
  font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--green);
  background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);
  padding:4px 10px;border-radius:4px;
}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ── HERO BANNER ── */
.hero{
  text-align:center;padding:40px 24px 20px;
  background:linear-gradient(180deg,rgba(59,130,246,.04) 0%,transparent 100%);
}
.hero h1{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;letter-spacing:1px;margin-bottom:8px}
.hero h1 span{color:var(--accent)}
.hero p{font-size:14px;color:var(--muted);max-width:640px;margin:0 auto;line-height:1.6}
.hero .disclaimer{
  font-size:11px;color:var(--dim);margin-top:12px;
  font-family:'JetBrains Mono',monospace;letter-spacing:.3px;
}

/* ── SOURCE TABS ── */
.source-bar{
  display:flex;justify-content:center;gap:8px;padding:16px 24px 8px;flex-wrap:wrap;
}
.source-tab{
  font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;
  padding:10px 20px;border-radius:6px;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--muted);
  transition:all .2s;position:relative;
}
.source-tab:hover{border-color:var(--border2);color:var(--text)}
.source-tab.active{
  background:var(--accent);color:#fff;border-color:var(--accent);
}
.source-tab .tab-count{
  font-size:10px;font-weight:400;opacity:.7;margin-left:6px;
}
.source-tab .tab-pulse{
  position:absolute;top:6px;right:6px;width:5px;height:5px;border-radius:50%;
  background:var(--green);animation:pulse 2s infinite;
}

/* ── FEED CONTROLS ── */
.feed-controls{
  display:flex;justify-content:space-between;align-items:center;
  max-width:1200px;margin:0 auto;padding:12px 24px;
}
.auto-label{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.feed-stats{display:flex;gap:16px;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace}
.feed-stats span{display:flex;align-items:center;gap:4px}

/* ── FEED CONTAINER ── */
.feed{max-width:1200px;margin:0 auto;padding:0 24px 60px}

.feed-item{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:14px;overflow:hidden;
  transition:border-color .2s;
}
.feed-item:hover{border-color:var(--border2)}

.feed-item-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;border-bottom:1px solid var(--border);
  background:var(--surface2);
}
.feed-source{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;
  text-transform:uppercase;letter-spacing:1px;color:var(--cyan);
}
.feed-time{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}

.feed-columns{display:grid;grid-template-columns:1fr 1fr;min-height:0}

.feed-col{padding:16px;position:relative}
.feed-col:first-child{border-right:1px solid var(--border)}
.feed-col-label{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;
  text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;
  display:flex;align-items:center;gap:6px;
}
.label-original{color:var(--muted)}
.label-nti{color:var(--accent)}

.feed-headline{font-size:16px;font-weight:600;line-height:1.4;margin-bottom:8px}
.feed-summary{font-size:13px;color:var(--muted);line-height:1.6}
.feed-link{font-size:11px;color:var(--accent2);text-decoration:none;margin-top:8px;display:inline-block}
.feed-link:hover{text-decoration:underline}

/* NTI results side */
.nti-score-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.nti-chip{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;
  padding:3px 8px;border-radius:4px;
}
.chip-good{background:#14532d;color:#86efac}
.chip-warn{background:#78350f;color:#fde68a}
.chip-bad{background:#7f1d1d;color:#fca5a5}
.chip-info{background:rgba(59,130,246,.15);color:var(--accent2)}

.nti-findings{font-size:13px;color:var(--text);line-height:1.6}
.nti-finding-label{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--purple);margin-top:8px;margin-bottom:3px}
.nti-tilt-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.nti-tilt-tag{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;
  padding:2px 7px;border-radius:3px;background:var(--surface3);color:var(--amber);
}

.nti-spinner{
  display:flex;align-items:center;gap:8px;
  font-size:12px;color:var(--muted);font-family:'JetBrains Mono',monospace;
  padding:20px 0;
}
.nti-spinner .spin{
  width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .6s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── SKELETON LOADING ── */
.skeleton-item{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:14px;overflow:hidden;
}
.skeleton-header{height:40px;background:var(--surface2);border-bottom:1px solid var(--border)}
.skeleton-body{display:grid;grid-template-columns:1fr 1fr;min-height:120px}
.skeleton-col{padding:16px}
.skeleton-col:first-child{border-right:1px solid var(--border)}
.skeleton-line{height:12px;background:var(--surface2);border-radius:4px;margin-bottom:8px;animation:shimmer 1.5s infinite}
.skeleton-line.w80{width:80%}
.skeleton-line.w60{width:60%}
.skeleton-line.w90{width:90%}
.skeleton-line.w40{width:40%}
@keyframes shimmer{0%{opacity:.4}50%{opacity:.7}100%{opacity:.4}}

/* ── EMPTY STATE ── */
.empty-state{
  text-align:center;padding:60px 20px;
  font-size:14px;color:var(--muted);
}
.empty-state .icon{font-size:40px;margin-bottom:12px;opacity:.3}

/* ── RESPONSIVE ── */
@media(max-width:768px){
  .feed-columns{grid-template-columns:1fr;gap:0}
  .feed-col:first-child{border-right:none;border-bottom:1px solid var(--border)}
  .hero h1{font-size:18px}
  .source-tab{padding:8px 14px;font-size:11px}
}

/* ── FOOTER ── */
.footer{
  text-align:center;padding:24px;font-size:11px;color:var(--dim);
  border-top:1px solid var(--border);margin-top:20px;
  font-family:'JetBrains Mono',monospace;
}
.footer a{color:var(--accent);text-decoration:none}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo"><a href="/">ARTIFACT ZERO</a></div>
  <div class="topbar-right">
    <div class="live-badge"><span class="live-dot"></span>LIVE FEED</div>
  </div>
</div>

<div class="hero">
  <h1>NTI <span>LIVE FEED</span></h1>
  <p>Real-time news pulled from major outlets and run through the NTI structural analysis engine. Same information, shown two ways — side by side.</p>
  <div class="disclaimer">We don't say correct. We say different. You decide.</div>
</div>

<div class="source-bar" id="sourceTabs"></div>

<div class="feed-controls">
  <div class="auto-label">Auto-refreshes every 120s</div>
  <div class="feed-stats">
    <span>Items analyzed: <strong id="statCount">0</strong></span>
    <span>Avg NII: <strong id="statNII">—</strong></span>
    <span>Last update: <strong id="statTime">—</strong></span>
  </div>
</div>

<div class="feed" id="feed">
  <!-- skeleton placeholders -->
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w80"></div><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div></div><div class="skeleton-col"><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div></div></div></div>
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div></div><div class="skeleton-col"><div class="skeleton-line w40"></div><div class="skeleton-line w90"></div><div class="skeleton-line w60"></div></div></div></div>
  <div class="skeleton-item"><div class="skeleton-header"></div><div class="skeleton-body"><div class="skeleton-col"><div class="skeleton-line w60"></div><div class="skeleton-line w80"></div><div class="skeleton-line w90"></div></div><div class="skeleton-col"><div class="skeleton-line w80"></div><div class="skeleton-line w40"></div><div class="skeleton-line w60"></div></div></div></div>
</div>

<div class="footer">
  Artifact Zero Labs · NTI Live Feed · Rule-based structural analysis, zero LLM dependency · <a href="/">Main Dashboard</a> · <a href="/health">Health</a>
</div>

<script>
// ── CONFIG ──
const SOURCES = [
  { id: 'reuters',  name: 'REUTERS',       rss: 'https://feeds.reuters.com/reuters/topNews' },
  { id: 'ap',       name: 'AP NEWS',       rss: 'https://feeds.apnews.com/rss/apf-topnews' },
  { id: 'bbc',      name: 'BBC WORLD',     rss: 'https://feeds.bbci.co.uk/news/world/rss.xml' },
];

const REFRESH_INTERVAL = 120000; // 2 minutes
const MAX_ITEMS = 15;

let activeSource = SOURCES[0].id;
let feedCache = {};     // { sourceId: [ {title, summary, link, pubDate, ntiResult} ] }
let refreshTimer = null;
let totalAnalyzed = 0;
let niiSum = 0;

// ── INIT ──
function init() {
  renderTabs();
  SOURCES.forEach(s => { feedCache[s.id] = []; });
  fetchAllSources();
  refreshTimer = setInterval(fetchAllSources, REFRESH_INTERVAL);
}

// ── TABS ──
function renderTabs() {
  const bar = document.getElementById('sourceTabs');
  bar.innerHTML = SOURCES.map(s => `
    <div class="source-tab ${s.id === activeSource ? 'active' : ''}" onclick="switchSource('${s.id}')">
      ${s.name}
      <span class="tab-count" id="count-${s.id}">(0)</span>
      <span class="tab-pulse"></span>
    </div>
  `).join('');
}

function switchSource(id) {
  activeSource = id;
  renderTabs();
  renderFeed();
}

// ── FETCH RSS VIA BACKEND PROXY ──
async function fetchAllSources() {
  for (const source of SOURCES) {
    try {
      await fetchSource(source);
    } catch (e) {
      console.error(`Failed to fetch ${source.name}:`, e);
    }
  }
  updateStats();
}

async function fetchSource(source) {
  try {
    const res = await fetch('/api/rss-proxy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url: source.rss, max_items: MAX_ITEMS })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!data.items || !data.items.length) return;

    const existing = new Set(feedCache[source.id].map(i => i.title));
    const newItems = data.items.filter(i => !existing.has(i.title));

    // Add new items and run NTI on each
    for (const item of newItems) {
      const entry = {
        title: item.title || '',
        summary: item.summary || item.description || '',
        link: item.link || '',
        pubDate: item.pubDate || '',
        source: source.name,
        sourceId: source.id,
        ntiResult: null,
        ntiLoading: true
      };
      feedCache[source.id].unshift(entry);

      // Render immediately with loading state
      if (source.id === activeSource) renderFeed();

      // Run NTI analysis
      try {
        const ntiRes = await fetch('/nti', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: `${entry.title}. ${entry.summary}` })
        });
        const ntiData = await ntiRes.json();
        entry.ntiResult = ntiData;
        entry.ntiLoading = false;
        totalAnalyzed++;
        if (ntiData.nii?.nii_score != null) niiSum += ntiData.nii.nii_score;
      } catch (e) {
        entry.ntiLoading = false;
        entry.ntiError = true;
      }

      if (source.id === activeSource) renderFeed();
    }

    // Cap items
    if (feedCache[source.id].length > MAX_ITEMS) {
      feedCache[source.id] = feedCache[source.id].slice(0, MAX_ITEMS);
    }

    // Update tab count
    const countEl = document.getElementById(`count-${source.id}`);
    if (countEl) countEl.textContent = `(${feedCache[source.id].length})`;

  } catch (e) {
    console.error(`RSS fetch error for ${source.name}:`, e);
  }
}

// ── RENDER ──
function renderFeed() {
  const feed = document.getElementById('feed');
  const items = feedCache[activeSource] || [];

  if (!items.length) {
    feed.innerHTML = `<div class="empty-state"><div class="icon">◎</div>Loading feed from ${SOURCES.find(s=>s.id===activeSource)?.name}...</div>`;
    return;
  }

  feed.innerHTML = items.map(item => renderItem(item)).join('');
}

function renderItem(item) {
  const timeStr = item.pubDate ? formatTime(item.pubDate) : '';

  let ntiCol;
  if (item.ntiLoading) {
    ntiCol = `<div class="nti-spinner"><div class="spin"></div>Running NTI analysis...</div>`;
  } else if (item.ntiError) {
    ntiCol = `<div style="color:var(--dim);font-size:12px">Analysis unavailable</div>`;
  } else {
    ntiCol = renderNTI(item.ntiResult);
  }

  return `
    <div class="feed-item">
      <div class="feed-item-header">
        <div class="feed-source">${item.source}</div>
        <div class="feed-time">${timeStr}</div>
      </div>
      <div class="feed-columns">
        <div class="feed-col">
          <div class="feed-col-label label-original">● ORIGINAL</div>
          <div class="feed-headline">${escHtml(item.title)}</div>
          <div class="feed-summary">${escHtml(item.summary)}</div>
          ${item.link ? `<a class="feed-link" href="${escHtml(item.link)}" target="_blank" rel="noopener">Read original →</a>` : ''}
        </div>
        <div class="feed-col">
          <div class="feed-col-label label-nti">◆ NTI STRUCTURAL ANALYSIS</div>
          ${ntiCol}
        </div>
      </div>
    </div>
  `;
}

function renderNTI(data) {
  if (!data || data.error) return '<div style="color:var(--dim);font-size:12px">No data</div>';

  const nii = data.nii || {};
  const fm = data.parent_failure_modes || {};
  const tilt = data.tilt_taxonomy || [];
  const score = nii.nii_score ?? 0;
  const scoreClass = score >= 0.8 ? 'chip-good' : score >= 0.5 ? 'chip-warn' : 'chip-bad';
  const scoreLabel = score >= 0.8 ? 'HIGH INTEGRITY' : score >= 0.5 ? 'MODERATE' : 'LOW INTEGRITY';

  // Failure modes
  const modes = ['UDDS', 'DCE', 'CCA'];
  const activeFailures = modes.filter(m => {
    const state = fm[m]?.[`${m.toLowerCase()}_state`] || fm[m]?.[`${m.toLowerCase()}_state`] || '';
    return state && !state.includes('FALSE');
  });

  // Build
  let html = `<div class="nti-score-row">`;
  html += `<span class="nti-chip ${scoreClass}">NII: ${(score * 100).toFixed(0)}% — ${scoreLabel}</span>`;
  if (activeFailures.length) {
    html += `<span class="nti-chip chip-bad">${activeFailures.join(' + ')} DETECTED</span>`;
  } else {
    html += `<span class="nti-chip chip-good">NO FAILURE MODES</span>`;
  }
  html += `</div>`;

  // Breakdown
  html += `<div class="nti-findings">`;

  // Constraints
  const constraints = data.layers?.L0_reality_substrate?.constraints_found || [];
  if (constraints.length) {
    html += `<div class="nti-finding-label">CONSTRAINTS DETECTED</div>`;
    html += `<div style="font-size:12px;color:var(--muted)">${constraints.map(c => `<code style="background:var(--surface3);padding:1px 5px;border-radius:3px;font-size:11px">${escHtml(c)}</code>`).join(' ')}</div>`;
  }

  // Framing
  const framing = data.layers?.L2_interpretive_framing || {};
  const hedges = framing.hedge_markers || [];
  const reassurance = framing.reassurance_markers || [];
  const blends = framing.category_blend_markers || [];
  const framingItems = [...hedges, ...reassurance, ...blends];
  if (framingItems.length) {
    html += `<div class="nti-finding-label">FRAMING MARKERS</div>`;
    html += `<div style="font-size:12px;color:var(--muted)">${framingItems.map(f => `"${escHtml(f)}"`).join(', ')}</div>`;
  }

  // Tilt
  if (tilt.length) {
    html += `<div class="nti-finding-label">TILT CATEGORIES</div>`;
    html += `<div class="nti-tilt-tags">${tilt.map(t => `<span class="nti-tilt-tag">${t}</span>`).join('')}</div>`;
  }

  // Failure mode detail
  if (activeFailures.length) {
    html += `<div class="nti-finding-label">FAILURE MODES</div>`;
    activeFailures.forEach(m => {
      const labels = { UDDS: 'Upstream Denial via Downstream Substitution', DCE: 'Deferred Constraint Externalization', CCA: 'Constraint Collapse via Aggregation' };
      const st = fm[m]?.[`${m.toLowerCase()}_state`] || '';
      const severity = st.includes('CONFIRMED') ? 'CONFIRMED' : 'PROBABLE';
      html += `<div style="font-size:12px;color:var(--red);margin-top:2px">● ${m}: ${labels[m]} (${severity})</div>`;
    });
  }

  if (!constraints.length && !framingItems.length && !tilt.length && !activeFailures.length) {
    html += `<div style="color:var(--green);font-size:13px;margin-top:4px">✓ Clean structural profile — no drift, framing, or failure modes detected.</div>`;
  }

  html += `</div>`;
  return html;
}

// ── UTILS ──
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function formatTime(dateStr) {
  try {
    const d = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - d) / 60000);
    if (diff < 1) return 'Just now';
    if (diff < 60) return `${diff}m ago`;
    if (diff < 1440) return `${Math.floor(diff / 60)}h ago`;
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  } catch { return dateStr; }
}

function updateStats() {
  document.getElementById('statCount').textContent = totalAnalyzed;
  document.getElementById('statNII').textContent = totalAnalyzed > 0 ? (niiSum / totalAnalyzed * 100).toFixed(0) + '%' : '—';
  document.getElementById('statTime').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

// ── GO ──
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
