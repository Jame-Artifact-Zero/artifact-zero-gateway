{% extends "base.html" %}
{% block title %}Score — Artifact Zero{% endblock %}
{% block body_class %}page-score{% endblock %}

{% block head %}
<style>
.main{max-width:720px;margin:0 auto;padding:40px 20px 80px}

h1{font-family:'JetBrains Mono',monospace;font-size:24px;font-weight:700;margin-bottom:6px}
.subtitle{color:var(--muted);font-size:14px;margin-bottom:30px}
.free-badge{display:inline-block;background:rgba(0,232,156,.12);color:var(--green);font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 8px;border-radius:4px;margin-left:8px}

textarea{
  width:100%;min-height:160px;background:var(--surface);border:1px solid var(--border);
  color:var(--text);padding:16px;border-radius:8px;font-family:'DM Sans',sans-serif;
  font-size:15px;line-height:1.6;resize:vertical;outline:none;transition:border .2s;
}
textarea:focus{border-color:var(--accent)}
textarea::placeholder{color:#3d4452}

.controls{display:flex;align-items:center;justify-content:space-between;margin-top:12px;flex-wrap:wrap;gap:8px}
.btn{padding:10px 24px;border-radius:6px;border:none;font-size:14px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.btn-score{background:var(--green);color:#000;font-size:15px;padding:12px 32px}
.btn-score:hover{background:#16a34a}
.btn-score:disabled{background:var(--surface2);color:var(--muted);cursor:default}
.btn-sample{background:var(--surface2);color:var(--muted);font-size:12px;padding:8px 14px}
.btn-sample:hover{color:var(--text);background:var(--border)}
.char-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted)}

.usage-bar{margin-top:16px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-size:12px}
.usage-bar .label{color:var(--muted);font-family:'JetBrains Mono',monospace}
.usage-bar .count{color:var(--text);font-family:'JetBrains Mono',monospace;font-weight:600}
.usage-bar a{color:var(--accent);text-decoration:none;font-family:'JetBrains Mono',monospace}

/* Results */
.results{display:none;margin-top:30px}
.results.show{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.score-hero{text-align:center;padding:30px;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:20px}
.score-number{font-family:'JetBrains Mono',monospace;font-size:64px;font-weight:700;line-height:1}
.score-number.high{color:var(--green)}
.score-number.mid{color:var(--amber)}
.score-number.low{color:var(--red)}
.score-number.crit{color:var(--red)}
.score-label{font-family:'JetBrains Mono',monospace;font-size:13px;margin-top:6px;text-transform:uppercase;letter-spacing:2px}
.score-label.high{color:var(--green)}
.score-label.mid{color:var(--amber)}
.score-label.low{color:var(--red)}
.score-label.crit{color:var(--red)}

.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
@media(max-width:500px){.detail-grid{grid-template-columns:1fr}}
.detail-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px}
.detail-card h3{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.detail-card .value{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600}
.detail-card .value.green{color:var(--green)}
.detail-card .value.red{color:var(--red)}
.detail-card .value.amber{color:var(--amber)}

.failure-row{display:flex;gap:8px;margin-bottom:6px;align-items:center}
.failure-badge{font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 8px;border-radius:4px;font-weight:600}
.failure-badge.confirmed{background:#ef444422;color:var(--red)}
.failure-badge.probable{background:#f59e0b22;color:var(--amber)}
.failure-badge.false{background:rgba(0,232,156,.12);color:var(--green)}
.failure-name{font-size:13px;color:var(--muted)}

.tilt-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tilt-tag{font-family:'JetBrains Mono',monospace;font-size:11px;padding:3px 8px;border-radius:4px;background:var(--surface2);color:var(--amber)}

.meta-row{display:flex;gap:16px;margin-top:16px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);flex-wrap:wrap}

</style>
{% endblock %}

{% block content %}
<div class="main">

<h1>Score your text <span class="free-badge">10 free / month</span></h1>
<p class="subtitle">Paste any message, email, or AI output. Get a structural integrity score in milliseconds.</p>

<textarea id="input" placeholder="Paste your text here...&#10;&#10;Example: &quot;I completely understand your concerns and I want to assure you that everything is fine. We've basically addressed all the issues and generally speaking the team is aligned. Don't worry about the timeline — we'll probably figure it out eventually.&quot;"></textarea>

<div class="controls">
  <div>
    <button class="btn btn-score" id="scoreBtn" onclick="scoreText()">Score this →</button>
    <button class="btn btn-sample" onclick="loadSample()">Load sample</button>
  </div>
  <span class="char-count" id="charCount">0 / 50,000</span>
</div>

<div class="usage-bar" id="usageBar">
  <span class="label">Free tier</span>
  <span class="count" id="usageCount">— / 10 this month</span>
  <a href="/docs#pricing">Upgrade →</a>
</div>

<div id="ntiResults"></div>

</div>
{% endblock %}

{% block scripts %}
<script src="/static/nti-score-component.js"></script>

<script src="/static/nti-engine.js"></script>


<script>
const input = document.getElementById('input');
const charCount = document.getElementById('charCount');
const scoreBtn = document.getElementById('scoreBtn');

const SAMPLE = `I completely understand your concerns and I want to assure you that everything is fine. We've basically addressed all the issues and generally speaking the team is aligned. Don't worry about the timeline — we'll probably figure it out eventually. Rest assured we've got this covered.`;

input.addEventListener('input', () => {
  charCount.textContent = input.value.length.toLocaleString() + ' / 50,000';
});

function loadSample() {
  input.value = SAMPLE;
  input.dispatchEvent(new Event('input'));
}

function getUsage() {
  const key = 'az_free_usage_' + new Date().toISOString().slice(0, 7);
  return parseInt(localStorage.getItem(key) || '0');
}
function addUsage() {
  const key = 'az_free_usage_' + new Date().toISOString().slice(0, 7);
  const n = getUsage() + 1;
  localStorage.setItem(key, n);
  return n;
}
function updateUsageDisplay() {
  const used = getUsage();
  document.getElementById('usageCount').textContent = used + ' / 10 this month';
}
updateUsageDisplay();

async function scoreText() {
  const text = input.value.trim();
  if (!text) return;

  if (getUsage() >= 10) {
    alert('Free tier limit reached (10/month). Get an API key at /docs for more.');
    return;
  }

  scoreBtn.disabled = true;
  scoreBtn.textContent = 'Scoring...';

  try {
    const resp = await fetch('/nti', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    const data = await resp.json();
    if (data.error) {
      const el = document.getElementById('results');
      el.innerHTML = '<div style="text-align:center;padding:24px;color:#f59e0b;font-family:\'JetBrains Mono\',monospace;font-size:13px">' + data.error + '</div>';
      return;
    }
    addUsage();
    updateUsageDisplay();
    const el = document.getElementById('ntiResults');
    el.innerHTML = '';
    el.appendChild(NTIScore.render(data, text));
  } catch (e) {
    alert('Scoring failed: ' + e.message);
  } finally {
    scoreBtn.disabled = false;
    scoreBtn.textContent = 'Score this →';
  }
}
</script>


<script>
// Add rewrite capability to score page
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form') || document.querySelector('textarea');
  if (form) {
    const rw = document.createElement('div');
    rw.id = 'score-rewrite-out';
    rw.style.cssText = 'display:none;margin-top:16px;background:#12151b;border:1px solid #00e89c;border-radius:10px;padding:16px';
    const ta = document.querySelector('textarea');
    if (ta && ta.parentElement) {
      ta.parentElement.appendChild(rw);
      NTI.rewriteButton('textarea', '#score-rewrite-out');
    }
  }
});
</script>


{% endblock %}
