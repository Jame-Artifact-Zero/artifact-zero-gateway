{% extends "base.html" %}
{% block title %}SafeCheck — Artifact Zero{% endblock %}
{% block body_class %}page-safecheck{% endblock %}

{% block head %}
<style>
/* ── TIMER BAR ── */
.timer-bar{position:fixed;left:0;right:0;z-index:190;padding:8px 20px;display:flex;align-items:center;justify-content:space-between;background:rgba(10,12,16,.92);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
.timer-left{display:flex;align-items:center;gap:10px}
.timer-dot{width:8px;height:8px;border-radius:50%;transition:background .3s}
.timer-dot.frozen{background:var(--muted)}.timer-dot.green{background:var(--accent)}.timer-dot.amber{background:var(--amber)}.timer-dot.red{background:var(--red);animation:pulse-red 1s ease infinite}
@keyframes pulse-red{0%,100%{opacity:1}50%{opacity:.4}}
.timer-display{font-family:var(--az-mono);font-size:15px;font-weight:600;letter-spacing:1px;transition:color .3s}
.timer-display.frozen{color:var(--muted)}.timer-display.green{color:var(--accent)}.timer-display.amber{color:var(--amber)}.timer-display.red{color:var(--red)}
.timer-msg{font-size:11px;color:var(--muted)}

/* ── WORKSPACE ── */
.workspace{max-width:600px;margin:0 auto;padding:108px 16px 40px;display:flex;flex-direction:column;min-height:calc(100vh - 100px)}

/* Privacy */
.privacy-line{text-align:center;margin-bottom:16px;font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:center;gap:8px;line-height:1.5}
.privacy-line .lock{font-size:14px;opacity:.5}

/* ── PASTE ZONE (fixed position) ── */
.paste-zone{position:relative;background:var(--surface);border:2px dashed var(--border);border-radius:12px;transition:border-color .3s,border-style .3s;min-height:200px;flex-shrink:0}
.paste-zone.active{border-color:var(--accent);border-style:solid}
.paste-zone.expired{border-color:var(--red);opacity:.3;pointer-events:none}
.paste-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;transition:opacity .3s}
.paste-hint.hidden{opacity:0}
.paste-icon{font-size:28px;opacity:.2;margin-bottom:6px}
.paste-label{font-family:var(--az-mono);font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
.paste-sub{font-size:12px;color:#3d4452;margin-top:4px;font-weight:600}
textarea#pasteBox{width:100%;min-height:200px;background:transparent;border:none;color:var(--text);padding:20px;font-size:16px;font-family:var(--az-sans);line-height:1.7;resize:none;outline:none;position:relative;z-index:1}
textarea#pasteBox::placeholder{color:transparent}

/* ── SAFECHECK BUTTON ── */
.check-btn{width:100%;padding:16px;border:none;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer;font-family:var(--az-sans);transition:all .15s;margin-top:12px;-webkit-tap-highlight-color:transparent}
.check-btn.go{background:var(--accent);color:#0a0c10}
.check-btn.go:hover{background:#00d48c}
.check-btn.off{background:var(--surface2);color:var(--muted);cursor:default}
.check-btn:disabled{background:var(--surface2);color:var(--muted);cursor:default}

/* ── MESSAGING ZONE ── */
.msg-zone{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px 16px;text-align:center;transition:opacity .3s}
.msg-zone.faded{opacity:.12}
.msg-zone.hidden{display:none}
.msg-text{font-size:17px;font-weight:600;color:var(--text);line-height:1.5;max-width:320px}
.msg-text .hl{color:var(--accent)}
.msg-sub{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5;max-width:300px}

/* ── OBSERVATION CARDS ── */
.obs-section{display:none;margin-top:16px}
.obs-section.show{display:block;animation:slideUp .25s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

.obs-label{font-family:var(--az-mono);font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:2px;font-weight:600;margin-bottom:10px}

.obs-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.obs-text{flex:1;font-size:14px;line-height:1.5;color:var(--text)}
.obs-text .marker{color:var(--amber);font-weight:600}
.obs-action{flex-shrink:0;padding:9px 16px;background:var(--accent-dim,rgba(0,232,156,.12));color:var(--accent);border:1px solid rgba(0,232,156,.2);border-radius:8px;font-size:12px;font-weight:600;white-space:nowrap;cursor:default}

/* Suggestion text below some cards */
.obs-suggestion{font-size:12px;color:var(--accent);padding:0 16px 8px 28px;margin-top:-4px;line-height:1.5}

/* Clean card (no issues) */
.obs-clean{background:rgba(0,232,156,.06);border:1px solid rgba(0,232,156,.15);border-radius:10px;padding:16px 20px;text-align:center;font-size:15px;color:var(--accent);line-height:1.5}

/* ── ACTION BAR ── */
.action-bar{display:flex;gap:8px;margin-top:12px}
.ab-btn{flex:1;padding:14px;border:none;border-radius:8px;font-size:14px;font-weight:700;font-family:var(--az-sans);text-align:center;cursor:pointer;transition:all .15s;-webkit-tap-highlight-color:transparent}
.ab-copy{background:var(--accent);color:#0a0c10}
.ab-copy:hover{background:#00d48c}
.ab-copy.copied{background:#064e3b;color:var(--accent)}
.ab-reset{background:var(--surface2);color:var(--muted);border:1px solid var(--border)}
.ab-reset:hover{border-color:var(--accent);color:var(--accent)}

/* ── CLEARED OVERLAY ── */
.cleared-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:250;background:var(--bg);justify-content:center;align-items:center;flex-direction:column;gap:16px;padding:20px}
.cleared-overlay.show{display:flex;animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.cleared-icon{font-size:48px;opacity:.3;margin-bottom:8px}
.cleared-title{font-family:var(--az-mono);font-size:16px;color:var(--accent);letter-spacing:2px}
.cleared-sub{font-size:14px;color:var(--muted);max-width:340px;text-align:center;line-height:1.6}
.cleared-btn{padding:14px 32px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;font-family:var(--az-sans);border:none;background:var(--accent);color:#0a0c10;margin-top:8px}

/* ── MOBILE ── */
@media(max-width:600px){
  .timer-bar{padding:6px 16px}
  .timer-msg{font-size:10px}
  textarea#pasteBox{font-size:16px;min-height:180px;padding:16px}
  .check-btn{padding:16px;font-size:16px}
  .obs-card{padding:12px 14px;gap:10px}
  .obs-action{padding:8px 12px;font-size:11px}
}
</style>
{% endblock %}

{% block content %}
<!-- TIMER BAR -->
<div class="timer-bar">
  <div class="timer-left">
    <div class="timer-dot frozen" id="timerDot"></div>
    <span class="timer-display frozen" id="timerDisplay">3:00</span>
  </div>
  <span class="timer-msg" id="timerMsg">Your words stay on your device.</span>
</div>

<!-- WORKSPACE -->
<div class="workspace" id="workspace">

  <div class="privacy-line">
    <span class="lock">&#128274;</span>
    Nothing is stored. Nothing is shared. This page clears itself.
  </div>

  <!-- PASTE ZONE (never moves) -->
  <div class="paste-zone" id="pasteZone">
    <div class="paste-hint" id="pasteHint">
      <div class="paste-icon">&#128203;</div>
      <div class="paste-label">Write what you want to say</div>
      <div class="paste-sub">email · text · reply · anything</div>
    </div>
    <textarea id="pasteBox" autocomplete="off" spellcheck="false"></textarea>
  </div>

  <!-- SAFECHECK BUTTON -->
  <button class="check-btn off" id="checkBtn" disabled>SafeCheck</button>

  <!-- MESSAGING ZONE (visible when empty, fades when typing, hidden when results show) -->
  <div class="msg-zone" id="msgZone">
    <div class="msg-text" id="msgText">I used to tell my wife <span class="hl">"calm down."</span> It never once accomplished what I wanted it to accomplish. Not once. So I stopped.</div>
    <div class="msg-sub" id="msgSub">Type what you'd actually send. We'll show you what they'll hear.</div>
  </div>

  <!-- OBSERVATION CARDS (hidden until results) -->
  <div class="obs-section" id="obsSection">
    <div class="obs-label">What we noticed</div>
    <div id="obsCards"></div>
    <div class="action-bar" id="actionBar">
      <button class="ab-btn ab-copy" id="copyBtn" onclick="copyText()">&#128203; Copy</button>
      <button class="ab-btn ab-reset" onclick="startOver()">&#8617; Start over</button>
    </div>
  </div>

</div>

<!-- CLEARED OVERLAY -->
<div class="cleared-overlay" id="clearedOverlay">
  <div class="cleared-icon">&#128683;</div>
  <div class="cleared-title">SESSION CLEARED</div>
  <div class="cleared-sub">Your words are gone. Nothing was stored. Nothing was saved.</div>
  <button class="cleared-btn" onclick="startOver()">Paste something new</button>
</div>
{% endblock %}

{% block scripts %}
<script>
// ═══════════════════════════════════════════
// POSITION TIMER BAR below topbar
// ═══════════════════════════════════════════
(function(){
  function sync(){
    const tb=document.querySelector('.az-topbar');
    const bar=document.querySelector('.timer-bar');
    if(!tb||!bar)return;
    const h=tb.getBoundingClientRect().height;
    bar.style.top=h+'px';
    const ws=document.getElementById('workspace');
    if(ws)ws.style.paddingTop=(h+bar.getBoundingClientRect().height+16)+'px';
  }
  setTimeout(sync,50);setTimeout(sync,200);
  window.addEventListener('resize',sync);
  new MutationObserver(sync).observe(document.body,{childList:true,subtree:false});
})();

// ═══════════════════════════════════════════
// TIMER
// ═══════════════════════════════════════════
const TIMER_TOTAL=180;
let secondsLeft=TIMER_TOTAL,timerInterval=null,timerStarted=false,sessionActive=true;
const timerDisplay=document.getElementById('timerDisplay'),timerDot=document.getElementById('timerDot'),timerMsg=document.getElementById('timerMsg');

function fmt(s){return Math.floor(s/60)+':'+(s%60<10?'0':'')+(s%60)}
function updateTimerUI(){
  timerDisplay.textContent=fmt(secondsLeft);
  if(!timerStarted){timerDisplay.className='timer-display frozen';timerDot.className='timer-dot frozen';return}
  const st=secondsLeft<=30?'red':secondsLeft<=60?'amber':'green';
  timerDisplay.className='timer-display '+st;timerDot.className='timer-dot '+st;
}
function startTimer(){
  if(timerStarted)return;timerStarted=true;
  timerMsg.textContent='Session clears in '+fmt(secondsLeft)+'.';
  updateTimerUI();timerInterval=setInterval(tick,1000);
}
function tick(){
  if(!sessionActive)return;secondsLeft--;
  timerMsg.textContent='Session clears in '+fmt(secondsLeft)+'.';
  if(secondsLeft<=0){clearSession();return}updateTimerUI();
}
function clearSession(){
  sessionActive=false;clearInterval(timerInterval);
  document.getElementById('pasteBox').value='';
  document.getElementById('obsSection').className='obs-section';
  document.getElementById('obsCards').innerHTML='';
  document.getElementById('pasteZone').classList.add('expired');
  document.getElementById('pasteHint').classList.remove('hidden');
  document.getElementById('checkBtn').disabled=true;
  document.getElementById('checkBtn').className='check-btn off';
  document.getElementById('msgZone').className='msg-zone hidden';
  timerDisplay.textContent='0:00';timerDisplay.className='timer-display red';
  timerDot.className='timer-dot red';timerMsg.textContent='Session cleared.';
  document.getElementById('clearedOverlay').classList.add('show');
}
function startOver(){
  sessionActive=true;timerStarted=false;secondsLeft=TIMER_TOTAL;updateTimerUI();
  timerMsg.textContent='Your words stay on your device.';
  document.getElementById('pasteZone').classList.remove('expired','active');
  document.getElementById('pasteHint').classList.remove('hidden');
  document.getElementById('clearedOverlay').classList.remove('show');
  document.getElementById('obsSection').className='obs-section';
  document.getElementById('obsCards').innerHTML='';
  document.getElementById('msgZone').className='msg-zone';
  document.getElementById('checkBtn').disabled=true;
  document.getElementById('checkBtn').className='check-btn off';
  document.getElementById('checkBtn').textContent='SafeCheck';
  document.getElementById('pasteBox').value='';
  document.getElementById('pasteBox').focus();
}
updateTimerUI();

// ═══════════════════════════════════════════
// PASTE ZONE
// ═══════════════════════════════════════════
const pasteBox=document.getElementById('pasteBox'),pasteHint=document.getElementById('pasteHint'),
      pasteZone=document.getElementById('pasteZone'),checkBtn=document.getElementById('checkBtn'),
      msgZone=document.getElementById('msgZone');

pasteBox.addEventListener('input',function(){
  if(!sessionActive)return;
  const has=this.value.trim().length>0;
  pasteHint.classList.toggle('hidden',has);
  pasteZone.classList.toggle('active',has);
  checkBtn.disabled=!has;
  checkBtn.className=has?'check-btn go':'check-btn off';
  // Fade messaging when typing
  msgZone.classList.toggle('faded',has);
  if(has)startTimer();
});
pasteBox.addEventListener('focus',function(){if(sessionActive)pasteZone.classList.add('active')});
pasteBox.addEventListener('blur',function(){if(!this.value.trim())pasteZone.classList.remove('active')});

// ═══════════════════════════════════════════
// SAFECHECK — hit API, render observation cards
// ═══════════════════════════════════════════
checkBtn.addEventListener('click',async function(){
  if(!sessionActive)return;
  const text=pasteBox.value.trim();
  if(!text||text.length<10)return;
  this.disabled=true;this.textContent='Checking…';
  try{
    const res=await fetch('/api/v1/safecheck',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text})
    });
    const data=await res.json();
    if(data.error){
      this.textContent=data.error;this.disabled=false;return;
    }
    renderObservations(data);
    this.textContent='SafeCheck ✓';
  }catch(e){
    this.textContent='Connection error — try again';this.disabled=false;
  }
});

function renderObservations(data){
  const cards=data.observations||[];
  const el=document.getElementById('obsCards');
  el.innerHTML='';

  // Hide messaging
  msgZone.className='msg-zone hidden';

  if(cards.length===0||(cards.length===1&&cards[0].priority===0)){
    // Clean — no issues
    el.innerHTML='<div class="obs-clean">Your message is structurally clear. It says what it means.</div>';
  } else {
    cards.forEach(function(c){
      if(c.priority===0)return;
      let h='<div class="obs-card"><div class="obs-text">';
      // Highlight the marker word in the observation text if present
      if(c.marker&&c.text.includes('"')){
        h+=esc(c.text).replace(/&quot;([^&]+)&quot;/g,'<span class="marker">"$1"</span>');
      } else {
        h+=esc(c.text);
      }
      h+='</div>';
      if(c.action){
        h+='<div class="obs-action">'+esc(c.action)+'</div>';
      }
      h+='</div>';
      if(c.suggestion){
        h+='<div class="obs-suggestion">'+esc(c.suggestion)+'</div>';
      }
      el.innerHTML+=h;
    });
  }

  document.getElementById('obsSection').className='obs-section show';
  document.getElementById('obsSection').scrollIntoView({behavior:'smooth',block:'nearest'});
}

function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

// ═══════════════════════════════════════════
// COPY — copies the text from the paste box
// ═══════════════════════════════════════════
function copyText(){
  const text=pasteBox.value.trim();
  if(!text)return;
  navigator.clipboard.writeText(text).then(function(){
    const btn=document.getElementById('copyBtn');
    btn.innerHTML='Copied ✓';btn.classList.add('copied');
    setTimeout(function(){btn.innerHTML='&#128203; Copy';btn.classList.remove('copied')},2000);
  });
}
</script>
{% endblock %}
